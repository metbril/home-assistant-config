---
##################################################
# Packages / Safety / Lightning
#
# https://github.com/mrk-its/homeassistant-blitzortung
# https://www.vcloudinfo.com/2020/08/adding-a-lightning-sensor-to-home-assistant.html
# https://github.com/CCOSTAN/Home-AssistantConfig/blob/master/config/packages/lightning.yaml
#
##################################################

## The Blitzortung integration in installed and managed through the UI.

input_boolean:
  snooze_lightning:
    name: Snooze Lightning
    initial: false
    icon: mdi:weather-lightning

automation:

  - alias: "Lightning: Snooze"
    description: >-
      Snooze future lightning notifications.
    id: 1f295bb8-8925-4b22-8f75-9l1ghtn1nga8
    mode: single

    trigger:
      - platform: event
        event_type: mobile_app_notification_action
        event_data:
          action: "SNOOZE_LIGHTNING"

    action:
      - service: input_boolean.turn_on
        entity_id: input_boolean.snooze_lightning

  - alias: "Lightning: Un-snooze"
    description: "Reset lightning snooze at midnight."
    id: 54dc02ae-2df9-4fc5-85e1-d18ccc859144
    mode: single

    trigger:
      - platform: time
        at: "00:00:00"

    action:
      - service: input_boolean.turn_off
        entity_id: input_boolean.snooze_lightning

  - alias: 'Lightning: Notification'
    id: 6e054688-5e75-48bd-9411-52a3e26264d1
    mode: single

    trigger:
      - platform: state
        entity_id: sensor.blitzortung_lightning_counter

    condition:
      - condition: state
        entity_id: group.family
        state: 'home'
      - condition: numeric_state
        entity_id: sensor.blitzortung_lightning_counter
        above: 0
      - condition: state
        entity_id: input_boolean.snooze_lightning
        state: 'off'

    action:
      - service: notify.robert
        data:
          message: "Er is bliksem waargenomen binnen {{ states('sensor.blitzortung_lightning_distance') }} km vanaf ons huis. Wees voorzichtig buitenshuis."
          data:
            title: 'Bliksemwaarschuwing!'
            actions:
              - action: "SNOOZE_LIGHTNING"
                title: "Stilhouden tot morgen"
              - action: "MAP"
                title: "Toon kaart"
                url: "/map"

      # - delay:
      #     minutes: 60
