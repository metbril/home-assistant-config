################################################
## Packages / Energy / DSMR
################################################

homeassistant:
  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'dsmr'

    ################################################
    ## Sensor
    ################################################

    sensor.daily_gas:
      <<: *customize
      friendly_name: Dagelijks gasverbruik

    sensor.daily_power:
      <<: *customize
      friendly_name: Dagelijks energieverbruik
      icon: mdi:counter
      unit_of_measurement: kWu

    sensor.daily_power_offpeak:
      <<: *customize
      friendly_name: Dagelijks energieverbruik dal

    sensor.daily_power_peak:
      <<: *customize
      friendly_name: Dagelijks energieverbruik piek

    sensor.gas_consumption:
      <<: *customize
      friendly_name: Gasverbruik
      unit_of_measurement: mÂ³

    sensor.hourly_gas_consumption:
      hidden: true

    sensor.long_power_failure_count:
      <<: *customize
      friendly_name: Aantal langdurige storingen

    sensor.monthly_gas:
      <<: *customize
      friendly_name: Maandelijks gasverbruik

    sensor.monthly_power:
      <<: *customize
      friendly_name: Maandelijks energieverbruik
      icon: mdi:counter
      unit_of_measurement: kWu

    sensor.monthly_power_offpeak:
      <<: *customize
      friendly_name: Maandelijks energieverbruik dal

    sensor.monthly_power_peak:
      <<: *customize
      friendly_name: Maandelijks energieverbruik piek

    sensor.power_consumption:
      <<: *customize
      friendly_name: Energieverbruik

    sensor.power_consumption_low:
      <<: *customize
      friendly_name: Energieverbruik laag tarief
      unit_of_measurement: kWu

    sensor.power_consumption_normal:
      <<: *customize
      friendly_name: Energieverbruik normaal tarief
      unit_of_measurement: kWu

    sensor.power_consumption_phase_l1:
      <<: *customize
      hidden: true

    sensor.power_consumption_phase_l2:
      <<: *customize
      hidden: true

    sensor.power_consumption_phase_l3:
      <<: *customize
      hidden: true

    sensor.power_production:
      <<: *customize
      hidden: true

    sensor.power_production_low:
      <<: *customize
      hidden: true

    sensor.power_production_normal:
      <<: *customize
      hidden: true

    sensor.power_production_phase_l1:
      <<: *customize
      hidden: true

    sensor.power_production_phase_l2:
      <<: *customize
      hidden: true

    sensor.power_production_phase_l3:
      <<: *customize
      hidden: true

    sensor.power_tariff:
      <<: *customize
      hidden: true

    sensor.power_tariff_nl:
      <<: *customize
      friendly_name: Energietarief
      icon: mdi:currency-eur

    sensor.voltage_sags_phase_l1:
      <<: *customize
      hidden: true

    sensor.voltage_sags_phase_l2:
      <<: *customize
      hidden: true

    sensor.voltage_sags_phase_l3:
      <<: *customize
      hidden: true

    sensor.voltage_swells_phase_l1:
      <<: *customize
      hidden: true

    sensor.voltage_swells_phase_l2:
      <<: *customize
      hidden: true

    sensor.voltage_swells_phase_l3:
      <<: *customize
      hidden: true

################################################
## Sensor
################################################

sensor:
  - platform: dsmr
    port: /dev/serial/by-id/usb-FTDI_FT232R_USB_UART_A5Z5VJCX-if00-port0
    dsmr_version: 4

  - platform: template
    sensors:

      power_tariff_nl: # vertaald in NL
        value_template: >-
          {% set value = states('sensor.power_tariff') %}
          {{ value | replace('low', 'laag') | replace('normal', 'normaal') }}

      daily_power:
        value_template: >-
          {{ states('sensor.daily_power_offpeak')|float +  
             states('sensor.daily_power_peak')|float }}

      monthly_power:
        value_template: >-
          {{ states('sensor.monthly_power_offpeak')|float +  
             states('sensor.monthly_power_peak')|float }}

##################################################
## REST Command
##################################################

rest_command:

  ## API documentation at https://www.mindergas.nl/member/api
  ## Post current gas reading to mindergas.nl for yesterday
  ## Should be executed as soon as the first meter change after midnight
  post_mindergas:
    url: https://www.mindergas.nl/api/gas_meter_readings
    method: post
    headers:
      Content-Type: application/json
      AUTH-TOKEN: !secret mindergas_token 
    payload: '{ "date": "{{(as_timestamp(now()) - (24*3600)) | timestamp_custom(''%Y-%m-%d'', True) }}", "reading" : "{{ states(''sensor.gas_consumption'') }}" }'

############################################################################
## Utility Meter
## https://www.home-assistant.io/components/utility_meter/
############################################################################

utility_meter:
  daily_power_offpeak:
    source: sensor.power_consumption_low
    cycle: daily
  daily_power_peak:
    source: sensor.power_consumption_normal
    cycle: daily
  daily_gas:
    source: sensor.gas_consumption
    cycle: daily
  monthly_power_offpeak:
    source: sensor.power_consumption_low
    cycle: monthly
  monthly_power_peak:
    source: sensor.power_consumption_normal
    cycle: monthly
  monthly_gas:
    source: sensor.gas_consumption
    cycle: monthly

############################################################################
## Notify
############################################################################

notify:
  - name: energy_consumption
    platform: file
    filename: energy_consumption.csv
    timestamp: false

############################################################################
## Script
############################################################################

script:
  log_energy_consumption:
    sequence:
      - service: notify.energy_consumption
        data_template: 
          message: >
            {{ now() }}, 
            {{ states('sensor.power_consumption_low') }}, 
            {{ states('sensor.power_consumption_normal') }}, 
            {{ states('sensor.gas_consumption')}}

############################################################################
## Automation
## https://www.home-assistant.io/components/automation/
############################################################################

automation:

  ## Post gas consumption to mindergas.nl daily at 00:15. 
  ## The gas reading is updated hourly around 10 minutes after the full hour
  - alias: Post Gas Consumption
    hide_entity: no # default no
    trigger:
      - platform: time
        ## run daily at 00:15:00
        ## gas meter reading usually updated around 0:06
        ## publishing should happen after that
        at: '00:15:00'
    action:
      - service: rest_command.post_mindergas
      - service: logbook.log
        data:
          name: Gasverbruik
          message: is verstuurd naar mindergas.nl
          entity_id: sensor.gas_consumption
          domain: sensor

  ## Log energy consumption every hour at the full hour.
  - alias: Log Energy Consumption
    trigger:
      - platform: time_pattern
        hours: '*'
        minutes: '0'
        seconds: '0'
    action:
      - service: script.log_energy_consumption
