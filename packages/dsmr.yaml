################################################
## Packages / DSMR
################################################

homeassistant:
  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'dsmr'

    ################################################
    ## Sensor
    ################################################

    sensor.gas_consumption:
      <<: *customize
      friendly_name: Gasverbruik
      unit_of_measurement: mÂ³

    sensor.power_consumption:
      <<: *customize
      friendly_name: "Energieverbruik"

    sensor.power_consumption_normal:
      <<: *customize
      friendly_name: "Energieverbruik normaal tarief"

    sensor.power_consumption_low:
      <<: *customize
      friendly_name: "Energieverbruik laag tarief"

    sensor.power_tariff_nl:
      <<: *customize
      friendly_name: "Energietarief"
      icon: mdi:currency-eur

    sensor.power_tariff:
      <<: *customize
      hidden: yes

    sensor.power_production:
      <<: *customize
      hidden: yes

    sensor.power_production_low:
      <<: *customize
      hidden: yes

    sensor.power_production_normal:
      <<: *customize
      hidden: yes

    sensor.power_production_phase_l1:
      <<: *customize
      hidden: yes

    sensor.power_production_phase_l2:
      <<: *customize
      hidden: yes

    sensor.power_production_phase_l3:
      <<: *customize
      hidden: yes

    sensor.power_consumption_phase_l1:
      <<: *customize
      hidden: yes

    sensor.power_consumption_phase_l2:
      <<: *customize
      hidden: yes

    sensor.power_consumption_phase_l3:
      <<: *customize
      hidden: yes

    sensor.voltage_sags_phase_l1:
      <<: *customize
      hidden: yes
    
    sensor.voltage_sags_phase_l2:
      <<: *customize
      hidden: yes
    
    sensor.voltage_sags_phase_l3:
      <<: *customize
      hidden: yes
    
    sensor.hourly_gas_consumption:
      <<: *customize
      hidden: yes

    sensor.voltage_swells_phase_l1:
      <<: *customize
      hidden: yes
    
    sensor.voltage_swells_phase_l2:
      <<: *customize
      hidden: yes
    
    sensor.voltage_swells_phase_l3:
      <<: *customize
      hidden: yes

    sensor.long_power_failure_count:
      <<: *customize
      friendly_name: "Aantal langdurige storingen"

    ################################################
    ## Group
    ################################################

    group.energy_view:
      <<: *customize
      friendly_name: Energie
      icon: mdi:flash
      
    group.power_meter_readings:
      <<: *customize
      friendly_name: Meterstanden Energie
      icon: mdi:flash
      control: hidden

    group.gas_meter_readings:
      <<: *customize
      friendly_name: Meterstanden Gas
      icon: mdi:fire
      control: hidden

    ################################################
    ## Script
    ################################################

    script.post_mindergas:
      <<: *customize
      friendly_name: Verzend naar mindergas.nl
      
################################################
## Sensor
################################################

sensor:
  - platform: dsmr
    port: /dev/serial/by-id/usb-FTDI_FT232R_USB_UART_A5Z5VJCX-if00-port0
    dsmr_version: 4

  - platform: template
    sensors:
      power_tariff_nl: # vertaald in NL
        value_template: >-
          {% set value = states.sensor.power_tariff.state %}
          {{ value | replace('low', 'laag') | replace('normal', 'normaal') }}
      
################################################
## Group
################################################

group:
  energy_view:
    name: Energy View
    view: yes
    entities:
      - group.power_meter_readings
      - group.gas_meter_readings

  power_meter_readings:
    name: Power Meter Readings
    entities:
      - sensor.power_consumption
      - sensor.power_tariff_nl
      - sensor.power_consumption_low
      - sensor.power_consumption_normal
      - sensor.long_power_failure_count

  gas_meter_readings:
    name: Gas Meter Readings
    entities:
      - sensor.gas_consumption
      - script.post_mindergas

##################################################
## Script
##################################################

## Manually posting is possible by using a script

script:
  ## API documentation at https://www.mindergas.nl/member/api
  post_mindergas:
    alias: Post Gas Consumption
    sequence:
      - service: shell_command.curl
        data_template:
          url: https://www.mindergas.nl/api/gas_meter_readings
          method: post
          headers:
            Content-Type: application/json
            AUTH-TOKEN: !secret mindergas_token 
          payload:
            date: "{{ (as_timestamp(now()) - (24*3600)) | timestamp_custom('%Y-%m-%d', True) }}"
            reading: "{{ states.sensor.gas_consumption.state }}"
      - service: logbook.log
        data:
          name: Gasverbruik
          message: is verstuurd naar mindergas.nl
          entity_id: sensor.gas_consumption
          domain: sensor

##################################################
## Automation
##################################################

automation:
  - alias: Post Gas Consumption
    hide_entity: no # default no
    trigger:
      - platform: time
        ## run daily at 00:15:00
        ## gas meter reading usually updated around 0:06
        ## publishing should happen after that
        hours: 00
        minutes: 15
        seconds: 00
    action:
      ## any additional logging is done in the script
      - service: script.post_mindergas
