######################################################################
## RDW
## Uses custom component
## https://github.com/eelcohn/home-assistant-rdw/
######################################################################

homeassistant:

  customize:
    package.node_anchors:
      customize: &customize
        package: 'rdw'

    ######################################################################
    ## Sensor
    ######################################################################

    sensor.niro_expdate:
      <<: *customize
      friendly_name: Vervaldatum APK Niro
    sensor.niro_insured:
      <<: *customize
      friendly_name: Niro verzekerd
    sensor.niro_recall:
      <<: *customize
      friendly_name: Terugroepacties Niro

    sensor.aygo_expdate:
      <<: *customize
      friendly_name: Vervaldatum APK Aygo
    sensor.aygo_insured:
      <<: *customize
      friendly_name: Aygo verzekerd
    sensor.aygo_recall:
      <<: *customize
      friendly_name: Terugroepacties Aygo

    ######################################################################
    ## Binary Sensor
    ######################################################################

    binary_sensor.niro_insured:
      <<: *customize
      friendly_name: Niro verzekerd
    binary_sensor.aygo_insured:
      <<: *customize
      friendly_name: Aygo verzekerd

######################################################################
## Sensor
######################################################################
sensor:

  - platform: rdw
    name: "Niro"
    plate: !secret rdw_niro_plate
    dateformat: '%Y-%m-%d'
    sensors:
      - expdate
      - insured
      - recall

  - platform: rdw
    name: "Aygo"
    plate: !secret rdw_aygo_plate
    dateformat: '%Y-%m-%d'
    sensors:
      - expdate
      - insured
      - recall

######################################################################
## Binary Sensor
######################################################################
binary_sensor:

  - platform: template
    sensors:
      niro_insured:
        friendly_name: "Niro Insured"
        entity_id: sensor.niro_insured
        value_template: "{{ is_state('sensor.niro_insured', 'True') }}"
        icon_template: "mdi:car"

      aygo_insured:
        friendly_name: "Aygo Insured"
        entity_id: sensor.aygo_insured
        value_template: "{{ is_state('sensor.niro_insured', 'True') }}"
        icon_template: "mdi:car"

######################################################################
## Automation
######################################################################
automation:
    # ------------------------------------------------------- #
    # Notify 21 days before the APK date expires              #
    # ------------------------------------------------------- #
  - alias: APK date expiration notification
    trigger:
      - platform: template
        value_template: "{{ ((as_timestamp(strptime(states('sensor.niro_expdate'), '%Y-%m-%d')) / 86400) | int) == ((as_timestamp(strptime(states('sensor.date'), '%Y-%m-%d')) / 86400) | int) + 21 }} }}"
    action:
      - service: notify.admin
        data_template:
          title: '*Auto*'
          message: De APK keuring verloopt op {{ states('sensor.niro_expdate') }}. Plan een APK keuring bij de garage.
