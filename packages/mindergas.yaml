################################################################
## Packages / MinderGas
################################################################
##
## https://www.mindergas.nl/member/api


##################################################
## Script
##################################################
##
## By using a script, you can also post manually

script:
  post_mindergas:
    alias: Verstuur gasverbruik
    sequence:
      - service: shell_command.curl
        data_template:
          method: post
          url: https://www.mindergas.nl/api/gas_meter_readings
          headers:
            Content-Type: application/json
            AUTH-TOKEN: !secret mindergas_token 
          payload:
            date: "{{ (as_timestamp(now()) - (24*3600)) | timestamp_custom('%Y-%m-%d', True) }}"
            reading: "{{ states.sensor.gas_consumption.state }}"
      - service: logbook.log
        data:
          name: Gasverbruik
          message: is verstuurd naar mindergas.nl
          entity_id: sensor.gas_consumption
          domain: sensor
      - service: notify.telegram
        data_template:
          message: "Gasverbruik van {{ states.sensor.gas_consumption.state}} m3 is verstuurd naar mindergas.nl"

##################################################
## Automation
##################################################

## gas meter reading usually updated around 0:06
## publishing should happen after that
automation:
  - alias: Verstuur gasverbruik
    hide_entity: no # default no
    trigger:
      - platform: time
        # run daily at 00:15:00
        hours: 00
        minutes: 15
        seconds: 00
    action:
      - service: script.post_mindergas
