###############################################################################
#   @package        :   Weather
#   @description    :   Get local weather conditions
#   @author         :   Robert van Bregt
###############################################################################

homeassistant:
  customize:

    ################################################
    ## Weather
    ################################################

    weather.dark_sky:
      friendly_name: Thuis

    ################################################
    ## Sensor
    ################################################

    sensor.buienradar_precipitation_forecast_average:
      friendly_name: Verwachte neerslag
      unit_of_measurement: mm/u

    sensor.buienradar_precipitation_forecast_total:
      friendly_name: Verwachte neerslag
      unit_of_measurement: mm

    sensor.dark_sky_apparent_temperature:
      friendly_name: Gevoelstemperatuur omgeving

    sensor.dark_sky_cloud_coverage:
      friendly_name: Bewolking

    sensor.dark_sky_humidity:
      friendly_name: Luchtvochtigheid omgeving

    sensor.dark_sky_ozone:
      friendly_name: Ozon Dark Sky
      icon: mdi:vector-triangle

    sensor.dark_sky_precip_intensity:
      friendly_name: Neerslagintensiteit omgeving
      unit_of_measurement: mm/u

    sensor.dark_sky_precip_probability:
      friendly_name: Neerslagkans omgeving

    sensor.dark_sky_pressure:
      friendly_name: Luchtdruk omgeving

    sensor.dark_sky_temperature:
      friendly_name: Temperatuur omgeving

    sensor.dark_sky_uv_index:
      friendly_name: UV-index Dark Sky

    sensor.dark_sky_wind_bearing:
      friendly_name: Windrichting omgeving

    sensor.dark_sky_wind_direction:
      friendly_name: Windrichting omgeving
      icon: mdi:compass

    sensor.dark_sky_wind_direction_nl:
      friendly_name: Windrichting omgeving
      icon: mdi:compass

    sensor.dark_sky_wind_speed:
      friendly_name: Windsnelheid omgeving

    ################################################
    ## Binary Sensor
    ################################################

    binary_sensor.car_wash:
      friendly_name: "Auto wassen"

    ################################################
    ## Automation
    ################################################

    automation.rain_alarm:
      friendly_name: Buienalarm

################################################
## Weather
################################################

## The met.no weather is added through the integration
## it can't be added manually

weather:
  - platform: darksky
    api_key: !secret darksky_api_key
    units: ca
    mode: daily

  - platform: buienradar
    name: Buienradar
    forecast: true

################################################
## Sensor
################################################

sensor:
  - platform: darksky
    api_key: !secret darksky_api_key
    units: ca
    language: nl
    scan_interval:                    # default 2 minutes
      minutes: 10                     
    monitored_conditions:
      - hourly_summary
      - daily_summary
      - temperature
      - apparent_temperature
      - humidity
      - pressure
      - visibility
      - wind_speed
      - wind_gust
      - wind_bearing
      - cloud_cover
      - ozone
      - uv_index
      - precip_intensity
      - precip_probability
      - precip_type
      - alerts

  - platform: buienradar
    name: Buienradar
    timeframe: 30                     # minutes to look ahead for precipitation
    monitored_conditions:
      - barometerfcname
      - precipitation_forecast_average
      - precipitation_forecast_total
      - irradiance
      - rainlast24hour
      - rainlasthour

  - platform: template
    sensors:
      dark_sky_wind_direction:
      # https://community.home-assistant.io/t/wind-direction/210532/6
        value_template: >
          {% set direction = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW','N'] %}
          {% set degree = states('sensor.dark_sky_wind_bearing')|float %}
          {{ direction[((degree+11.25)/22.5)|int] }} 
      dark_sky_wind_direction_nl:
        value_template: >
          {% set direction = ['N','NNO','NO','ONO','O','OZO','ZO','ZZO','Z','ZZW','ZW','WZW','W','WNW','NW','NNW','N'] %}
          {% set degree = states('sensor.dark_sky_wind_bearing')|float %}
          {{ direction[((degree+11.25)/22.5)|int] }} 

################################################
## Binary Sensor
################################################
binary_sensor:

  - platform: meteoalarm
    country: 'NL'
    province: 'Zuid-Holland'
    language: 'ne'

  - platform: car_wash
    weather: weather.dark_sky
  
  - platform: template
    sensors:
      rain_alarm:
        friendly_name: Rain Alarm
        value_template: "{{ states('sensor.buienradar_precipitation_forecast_average') | float > 0 }}"
        icon_template: "mdi:umbrella{% if states('sensor.buienradar_precipitation_forecast_average') | float == 0 %}-closed{% endif %}"

################################################
## Camera
################################################
camera:
  - platform: buienradar
    name: Buienradar
    dimension: 700                      # largest size

################################################
## Automation
################################################
automation:

  - alias: Notify Rain Alarm
    trigger:
      - platform: numeric_state
        entity_id: sensor.buienradar_precipitation_forecast_average
        above: 0
    action:
      - service: notify.all
        data_template:
          title: "Regenalarm"
          message: "De komende 30 minuten wordt {{ trigger.to_state.state }} {{ trigger.to_state.attributes.unit_of_measurement }} neerslag verwacht"

  - alias: Alert for weather warnings
    trigger:
      platform: state
      entity_id: binary_sensor.meteoalarm
      to: 'on'
    action:
      - service: notify.all
        data_template:
          title: "{{state_attr('binary_sensor.meteoalarm', 'headline')}}"
          message: "{{state_attr('binary_sensor.meteoalarm', 'description')}} is effectief op {{state_attr('binary_sensor.meteoalarm', 'effective')}}"
          data:
            url: https://meteoalarm.eu/ne_NL/1/0/NL009-Nederland.html

