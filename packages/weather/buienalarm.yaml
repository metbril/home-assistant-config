---
############################################################
# Buienalarm custom component
# https://github.com/gieljnssns/buienalarm-sensor-homeassistant
#
# Uses latitude/longitude from home assistant configuration
############################################################

## Customization and automation through UI

sensor:
  - platform: buienalarm
    name: Buienalarm
    timeframe: 15  # minutes
    monitored_conditions:
      - precipitation
      - precipitation_forecast_average
      - next_rain_forecast

template:
  sensor:
    - name: "Buienalarm next rain forecast minutes"
      unit_of_measurement: "min"
      state: >
        {% set forecast = states('sensor.buienalarm_next_rain_forecast') %}
        {% if forecast is not in [None, 'unavailable', 'unknown'] %}
          {{ ( ( as_timestamp(forecast) - as_timestamp(now()) ) / 60 ) | round }}
        {% else %}
          unavailable
        {% endif %}

    - name: Buienalarm Precipitation Forecast Level
      unique_id: 808f691c-6b69-4bb3-b52c-b11c50fd02db
      icon:
        mdi:weather-pouring
      availability: True  # TODO
      state: >-
        {% set value =
          states('sensor.buienalarm_precipitation_forecast_average')
          | float(0) %}
        {% if value < 0.1 %}
          0
        {% elif value < 1 %}
          1
        {% elif value < 3 %}
          2
        {% elif value < 10 %}
          3
        {% elif value >=10 %}
          4
        {% else %}
          unavailable
        {% endif %}
      attributes:
        label: >-
          {% set value =
            states('sensor.buienalarm_precipitation_forecast_average')
            | float(0) %}
          {% if value < 0.1 %}
            Geen neerslag
          {% elif value < 1 %}
            Lichte neerslag
          {% elif value < 3 %}
            Matige neerslag
          {% elif value < 10 %}
            Zware neerslag
          {% elif value >=10 %}
            Zware buien
          {% else %}
            unavailable
          {% endif %}

  binary_sensor:
    - name: Buienalarm
      unique_id: d8dabef5-3b3d-46d1-9062-3feb07c7c4a9
      state: >-
        {{ states('sensor.buienalarm_precipitation_forecast_average')
          | float(0) > 0 }}
      icon: >-
        mdi:umbrella{% if
          states('sensor.buienalarm_precipitation_forecast_average')
          | float(0) == 0 %}-closed{% endif %}
