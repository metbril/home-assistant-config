############################################################################
## Packages / Occupancy
##
## Inspired by a post by @Tomahawk in the community thread:
## https://community.home-assistant.io/t/55934/8
############################################################################

homeassistant:
  customize:

    ########################################################################
    ## Node Anchors
    ########################################################################

    package.node_anchors:
      customize: &customize
        package: 'occupancy'

    ########################################################################
    ## Binary Sensor
    ########################################################################

    binary_sensor.ha_mode:
      friendly_name: HA-mode

    ########################################################################
    ## Input Boolean
    ########################################################################

    input_boolean.ha_mode_home:
      friendly_name: Thuis
      icon: mdi:home-account

    input_boolean.ha_mode_away:
      friendly_name: Weg
      icon: mdi:exit-run

    input_boolean.ha_mode_night:
      friendly_name: Nacht
      icon: mdi:weather-night

    input_boolean.ha_mode_vacation:
      friendly_name: Vakantie
      icon: mdi:airplane-takeoff

    ########################################################################
    ## Sensor
    ########################################################################

    sensor.ha_mode:
      friendly_name: HA-mode

    ########################################################################
    ## Automation
    ########################################################################

    automation.ha_mode_sync:
      friendly_name: Synchroniseer HA Mode

############################################################################
## Input Boolean
## https://www.home-assistant.io/components/input_boolean/
## State is restored when no initial value is set
############################################################################

input_boolean:
  ha_mode_home:
  ha_mode_away:
  ha_mode_night:
  ha_mode_vacation:

############################################################################
## Sensor
############################################################################

sensor:
  - platform: template
    sensors:
      ha_mode:
        friendly_name: 'HA Mode'
        entity_id: 
          - input_boolean.ha_mode_home
          - input_boolean.ha_mode_away
          - input_boolean.ha_mode_night
          - input_boolean.ha_mode_vacation
        value_template: >-
          {% if is_state('input_boolean.ha_mode_home', 'on') %}
              home
          {% elif is_state('input_boolean.ha_mode_away', 'on') %}
              away
          {% elif is_state('input_boolean.ha_mode_night', 'on') %}
            night
          {% elif is_state('input_boolean.ha_mode_vacation', 'on') %}
            vacation
          {% endif %}
        icon_template: >-
          {% if is_state('input_boolean.ha_mode_home', 'on') %}
            mdi:home-account
          {% elif is_state('input_boolean.ha_mode_away', 'on') %}
            mdi:exit-run
          {% elif is_state('input_boolean.ha_mode_night', 'on') %}
            mdi:weather-night
          {% elif is_state('input_boolean.ha_mode_vacation', 'on') %}
            mdi:airplane-takeoff
          {% endif %}

############################################################################
## Binary Sensor
############################################################################

binary_sensor:
  - platform: template
    sensors:
      ha_mode:
        friendly_name: "HA Mode"
        entity_id: sensor.ha_mode
        value_template: >-
          {{ is_state('sensor.ha_mode', 'home') 
            or is_state('sensor.ha_mode', 'away')
            or is_state('sensor.ha_mode', 'night')
            or is_state('sensor.ha_mode', 'vacation') }}
        icon_template: >-
          {% if is_state('sensor.ha_mode', 'home') %}
            mdi:home-account
          {% elif is_state('sensor.ha_mode', 'away') %}
            mdi:exit-run
          {% elif is_state('sensor.ha_mode', 'night') %}
            mdi:weather-night
          {% elif is_state('sensor.ha_mode', 'vacation') %}
            mdi:airplane-takeoff
          {% endif %}

############################################################################
## Automation
############################################################################

automation:
  - alias: HA Mode Sync
    initial_state: true
    trigger:
      - platform: state
        entity_id: 
          - input_boolean.ha_mode_home
          - input_boolean.ha_mode_away
          - input_boolean.ha_mode_night
          - input_boolean.ha_mode_vacation
        to: 'on'
    action:
      - service: input_boolean.turn_off
        data_template:
          entity_id: >
            {% set booleans = [ 'input_boolean.ha_mode_home', 'input_boolean.ha_mode_away', 'input_boolean.ha_mode_night', 'input_boolean.ha_mode_vacation' ] | reject('equalto', trigger.entity_id) %}
            {{ booleans | list | join(', ') }}
