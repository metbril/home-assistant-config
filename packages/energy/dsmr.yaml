################################################
## Packages / Energy / DSMR
################################################

homeassistant:
  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'dsmr'
     
################################################
## Sensor
################################################

sensor:
  - platform: dsmr
    port: !secret dsmr_port
    dsmr_version: 4

  - platform: template
    sensors:
      power_tariff_nl: # vertaald in NL
        value_template: >-
          {% set value = states.sensor.power_tariff.state %}
          {{ value | replace('low', 'laag') | replace('normal', 'normaal') }}
      
################################################
## Group
################################################

group:
  power_meter_readings:
    name: Power Meter Readings
    entities:
      - sensor.power_consumption
      - sensor.power_tariff_nl
      - sensor.power_consumption_low
      - sensor.power_consumption_normal
      - sensor.long_power_failure_count

  gas_meter_readings:
    name: Gas Meter Readings
    entities:
      - sensor.gas_consumption
      - script.post_mindergas

##################################################
## REST Command
##################################################

rest_command:
  ## API documentation at https://www.mindergas.nl/member/api
  post_mindergas:
    url: https://www.mindergas.nl/api/gas_meter_readings
    method: post
    headers:
      Content-Type: application/json
      AUTH-TOKEN: !secret mindergas_token 
    payload: '{ "date": "{{(as_timestamp(now()) - (24*3600)) | timestamp_custom(''%Y-%m-%d'', True) }}", "reading" : "{{states.sensor.gas_consumption.state }}" }'

##################################################
## Automation
##################################################

automation:
  - alias: Post Gas Consumption
    hide_entity: no # default no
    trigger:
      - platform: time
        ## run daily at 00:15:00
        ## gas meter reading usually updated around 0:06
        ## publishing should happen after that
        ## upgrade to 0.90
        # hours: 00
        # minutes: 15
        # seconds: 00
        at: '00:15:00'
    action:
      - service: rest_command.post_mindergas
      - service: logbook.log
        data:
          name: Gasverbruik
          message: is verstuurd naar mindergas.nl
          entity_id: sensor.gas_consumption
          domain: sensor
