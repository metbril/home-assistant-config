---
##################################################
# Packages / Energy / Appliances
##################################################

homeassistant:
  customize:
    sensor.washing_machine_daily_energy:
      friendly_name: "Wasmachine dagelijks verbruik"
    sensor.tumble_dryer_daily_energy:
      friendly_name: "Wasdroger dagelijks verbruik"
    sensor.close_in_boiler_daily_energy:
      friendly_name: "Close-in boiler dagelijks verbruik"

# Washing machine is on when power
template:
  #
  # Template sensors to fix a bug in some Neo wall plugs.
  # The applied constant is the equivalent of 0x7FFFFFFF.
  # Device precision is 2 decimals.
  #
  # https://community.home-assistant.io/t/energy-consumption-for-neo-coolcam-plug/219844/26?u=metbril
  #
  - sensor:
    - name: "Close-in Boiler Energy"
      unique_id: eb89a9e4-4fea-458a-b84c-1f82f24b63f1
      unit_of_measurement: kWh
      device_class: energy
      state_class: total_increasing
      state: >-
        {% set value = states('sensor.close_in_boiler_raw_energy') | float(0) %}
        {% set const = 21474836.47 %}
        {% if value < 0 %}{{ (value + const) | round(2) }}
        {% else %}{{ value }}
        {% endif %}

    - name: "Tumble Dryer Energy"
      unique_id: 76269b18-7159-4409-9f26-72128fa2e116
      unit_of_measurement: kWh
      device_class: energy
      state_class: total_increasing
      state: >-
        {% set value = states('sensor.tumble_dryer_raw_energy') | float(0) %}
        {% set const = 21474836.47 %}
        {% if value < 0 %}{{ (value + const) | round(2) }}
        {% else %}{{ value }}
        {% endif %}

  # Appliance is on when power usage detected
  - binary_sensor:
      - name: Washing Machine
        unique_id: 7a04404c-be07-4651-82d1-74a804d5cf25
        state: >
          {{ states("sensor.washing_machine_power")
          | float(0) > 4 }}
        delay_off: "00:00:30"
        icon: >
          {% if is_state("binary_sensor.washing_machine", "on") %}
            mdi:washing-machine
          {% else %}
            mdi:washing-machine-off
          {% endif %}

      - name: Tumble Dryer
        unique_id: e266f060-376f-4067-8b9d-c8a21e49f890
        state: >
          {{ states("sensor.tumble_dryer_power")
          | float(0) > 2 }}
        delay_off: "00:00:30"
        icon: >
          {% if is_state("binary_sensor.tumble_dryer", "on") %}
            mdi:tumble-dryer
          {% else %}
            mdi:tumble-dryer-off
          {% endif %}

utility_meter:
  washing_machine_daily_energy:
    source: sensor.washing_machine_energy
    cycle: daily

  tumble_dryer_daily_energy:
    source: sensor.tumble_dryer_energy
    cycle: daily

  close_in_boiler_daily_energy:
    source: sensor.close_in_boiler_energy
    cycle: daily

input_datetime:
  washing_machine_on:
    name: "Wasmachine laatst gestart"
    has_date: true
    has_time: true

  washing_machine_off:
    name: "Wasmachine laatst gereed"
    has_date: true
    has_time: true

  tumble_dryer_on:
    name: "Wasdroger laatst gestart"
    has_date: true
    has_time: true

  tumble_dryer_off:
    name: "Wasdroger laatst gereed"
    has_date: true
    has_time: true

# Originally by @basnijholt
# https://github.com/basnijholt/home-assistant-config/blob/master/scripts.yaml
#
script:
  appliance_notification:
    alias: "Apparatuur: Notificatie"
    description: >
      This script is triggered when an appliance is turned 'on'.
      After getting some starting values, it will wait until the appliance
      is finished and send a notification.

      Please note: the script is aborted when HA is restarted during a run and
      no notification is sent.
    mode: parallel
    max: 20
    fields:
      name:
        description: name
        example: washing_machine
      emojis:
        description: emojis
        example: "ðŸ‘šðŸ‘•"
    variables:
      binary_sensor: "{{ 'binary_sensor.{}'.format(name) }}"
      friendly_name: "{{ name.capitalize().replace('_', ' ') }}"
      energy_sensor: "{{ 'sensor.{}_energy'.format(name) }}"
    sequence:
      - variables:
          start_time: "{{ as_timestamp(now()) }}"
          start_kwh: "{{ states(energy_sensor) }}"
      - wait_for_trigger:
          platform: template
          value_template: "{{ is_state(binary_sensor, 'off') }}"
        timeout: "04:00:00"
        continue_on_timeout: false
      - variables:
          end_time: "{{ as_timestamp(now()) }}"
          end_kwh: "{{ states(energy_sensor) }}"
      - variables:
          total_time: "{{ (end_time - start_time) }}"
          total_kwh: "{{ end_kwh - start_kwh }}"
      - variables:
          minutes: "{{ (total_time / 60) | round(0) }}"
          total_kwh_rounded: "{{ (total_kwh) | round(2) }}"
          price: >
            {{ (states('sensor.energy_rate_tarif_2') | float(0) * total_kwh)
              | round(2) }}
          price_formatted: "{{'{:0.2f}'.format(price)|replace('.', ',') }}"
      - service: notify.robert
        # TODO - "{{ states('sensor.nearest_parent_notify') }}"
        data:
          title: "Apparatuur"
          message: >
            {{ friendly_name }} is klaar na {{ minutes }} minuten
            en verbruikte {{ total_kwh_rounded }} kWh
            (â‚¬{{ price_formatted }}). {{ emojis }}

automation:

  ############################################################
  - alias: "Appliances: appliance started or finished"
    id: b2b10f8b-811d-4d38-930f-9961f6c3ecaf

    trigger:
      - platform: state
        entity_id:
          # add more entities as appropriate
          - binary_sensor.washing_machine
          - binary_sensor.tumble_dryer

    variables:
      from_state: "{{ trigger.from_state.state }}"
      to_state: "{{ trigger.to_state.state }}"
      name: "{{ trigger.entity_id.split('.', 1)[1] }}"

    condition: >
      {{ (to_state == 'on' and from_state == 'off') or
        (to_state == 'off' and from_state == 'on') }}

    action:
      service: input_datetime.set_datetime
      data:
        entity_id: "input_datetime.{{ name }}_{{ to_state }}"
        timestamp: "{{ now().timestamp() }}"

  ############################################################
  - alias: "Appliances: Washing machine notification"
    id: 51d696db-b786-437a-8ea0-7c5a819115ad
    trigger:
      platform: state
      entity_id: binary_sensor.washing_machine
      from: "off"
      to: "on"
    action:
      service: script.appliance_notification
      data:
        name: "washing_machine"
        emojis: "ðŸ§ºðŸ‘–ðŸ‘•"

  ############################################################
  - alias: "Appliances: Tumble dryer notification"
    id: fa3626ee-c4bd-410e-be39-06f322332bbe
    trigger:
      platform: state
      entity_id: binary_sensor.tumble_dryer
      from: "off"
      to: "on"
    action:
      service: script.appliance_notification
      data:
        name: "tumble_dryer"
        emojis: "ðŸ’¨ðŸ‘–ðŸ‘•"
