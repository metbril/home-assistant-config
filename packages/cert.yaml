################################################
## Packages / Cert
##
## Anything certificate and Let's Encrypt related
##
################################################

homeassistant:

  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'cert'

################################################
## Sensor
################################################

sensor:

  - platform: dnsip

  - platform: template
    sensors:
      certpem_last_updated:
        entity_id: sensor.certpem
        value_template: "{{ state_attr('sensor.certpem', 'last_updated') }}"

  - platform: cert_expiry
    host: !secret cert_expiry_host

################################################
## Automation
################################################
automation:

  ## Notify when SSL certificate has been renewed
  - alias: "Notify SSL Certificate Renewed"
    initial_state: on
    trigger:
      - platform: state
        entity_id: sensor.ssl_certificate_expiry
    condition: 
      - condition: template
        value_template: '{{ (trigger.to_state.state > trigger.from_state.state) }}'
    action:
      - service: notify.admin
        data_template:
          message: 'SSL-certificaat voor Home Assistant is vernieuwd van {{trigger.from_state.state}} naar {{trigger.to_state.state}}'
          title: "Nieuw apparaat"

  ## Restart NGinx addon when SSL certificate has changed (to load new cert)
  - alias: "Timestamp SSL cert changed"
    initial_state: on
    trigger:
      - platform: state
        entity_id: sensor.certpem_last_updated
    condition: 
      - condition: template
        value_template: "{{ (trigger.from_state.state != 'None') }}"
    action:
      - service: hassio.addon_restart
        data:
          addon: "53caca22_nginx_proxy"
      - service: notify.admin
        data_template:
          message: 'NGinx proxy is herstart om een nieuw SSL-certificaat te activeren. ({{trigger.from_state.state}})'
