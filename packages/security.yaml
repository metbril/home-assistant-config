################################################
## Packages / Security
################################################

homeassistant:
  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'security'

      expose: &expose
        <<: *customize
        haaska_hidden: false
        homebridge_hidden: false

    ################################################
    ## Binary Sensor
    ################################################

    binary_sensor.motion_garage:
      <<: *customize
      friendly_name: "Beweging garage"
      device_class: motion

    binary_sensor.flamingo_remote_button_a:
      <<: *customize
      friendly_name: "Flamingo Afstandsbediening A"
      icon: mdi:remote

    ################################################
    ## Switch
    ################################################

    switch.frontdoor_bell:
      <<: *customize
      friendly_name: 'Bel voordeur'
      icon: mdi:bell-ring
      assumed_state: off

    switch.mess_call:
      <<: *customize
      friendly_name: 'Bel verzamelen'
      icon: mdi:bell-ring
      assumed_state: off

    switch.power_garage_door:
      <<: *customize
      friendly_name: "Spanning garagedeur"
      assumed_state: Off

################################################
## 
################################################

############################################################
## Binary Sensor
############################################################

binary_sensor:
  - platform: rfxtrx
    automatic_add: false
    devices:
      0b110010011600020a010f70: # kaku motion
        name: motion_garage
      0b1100090029fc0201010f60: # flamingo remote A
        name: Flamingo Remote Button A

############################################################
## Switch
############################################################

switch:
  - platform: rfxtrx
    automatic_add: false
    devices:
      0a140f01000b5501010f60: # lighting5 it 2901.01 On
        name: Power Garage Door
      0b110005011afee601040f60: # beldrukker woonkamer
        name: Mess Call
        fire_event: true
      0b11001601131fb20c010f80: # beldrukker voordeur
        name: Frontdoor Bell
        fire_event: true

############################################################
## Automation
############################################################

automation:

  - alias: Frontdoor Bell Pressed
    initial_state: on
    trigger:
      - platform: event
        event_type: button_pressed
        event_data:
          entity_id: switch.frontdoor_bell
    action:
      - service: switch.turn_off
        entity_id: switch.frontdoor_bell
      - service: notify.all
        data_template:
          title: 'Bel voordeur'
          message: 'Er is aangebeld {{ as_timestamp(now()) | timestamp_custom("op %d-%m om %H:%M", True) }}'

  - alias: Mess Call Pressed
    initial_state: off
    trigger:
      - platform: event
        event_type: button_pressed
        event_data:
          entity_id: switch.mess_call
    action:
      - service: switch.turn_off
        entity_id: switch.mess_call
      - service: notify.all
        data:
          title: 'Etenstijd'
          message: 'Etenstijd!'

  - alias: Sync Garage Door Switch With Remote
    trigger:
      - platform: state
        entity_id: binary_sensor.flamingo_remote_button_a
    action:
      - service_template: >
          {% if trigger.to_state.state == "on" %}
            homeassistant.turn_on
          {% elif trigger.to_state.state == "off" %}
            homeassistant.turn_off
          {% endif %}
        entity_id:
          switch.power_garage_door

  # schakel de spanning van de garagedeur uit tussen 23:00 en 06:00
  - alias: Power off garage door after 23:00
    trigger:
      - platform: time
        at: '23:00:00'
    action:
      - service: homeassistant.turn_off
        entity_id: switch.power_garage_door
      - service: notify.admin
        data_template:
          message: 'Spanning garagedeur uitgeschakeld.'

  - alias: Power on garage door after 6:00
    trigger:
      - platform: time
        at: '06:00:00'
    condition:
      - condition: state
        entity_id: input_boolean.on_vacation
        state: 'off'
    action:
      - service: homeassistant.turn_on
        entity_id: switch.power_garage_door
      - service: notify.admin
        data_template:
          message: 'Spanning garagedeur ingeschakeld.'
