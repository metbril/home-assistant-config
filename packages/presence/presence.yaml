################################################
## Packages / Presence / Presence
################################################

homeassistant:
  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'presence'

    ################################################
    ## Group
    ################################################

    group.presence_view:
      <<: *customize
      friendly_name: Aanwezigheid
      icon: mdi:account

    group.family:
      <<: *customize
      friendly_name: Familie
      icon: mdi:human-male-female

    group.person_robert:
      <<: *customize
      friendly_name: Robert
      icon: mdi:human-male

    group.person_monique:
      <<: *customize
      friendly_name: Monique
      icon: mdi:human-female

    group.person_bjorn:
      <<: *customize
      friendly_name: BjÃ¶rn
      icon: mdi:human-male

################################################
## ASUSWRT
################################################

asuswrt:
  host: !secret asuswrt_host
  username: !secret asuswrt_username
  ssh_key: !secret asuswrt_ssh_key
  protocol: ssh
  port: 22
  mode: router

################################################
## MQTT
################################################

mqtt:
  # broker: core-mosquitto
  broker: !secret mqtt_cloudmqtt_broker
  port: !secret mqtt_cloudmqtt_port
  username: !secret mqtt_cloudmqtt_username
  password: !secret mqtt_cloudmqtt_password
  certificate: auto

################################################
## OwnTracks
################################################

owntracks:

################################################
## Device Tracker
################################################

# https://home-assistant.io/components/device_tracker/

device_tracker:
  - platform: asuswrt
    consider_home: 180
    interval_seconds: 60 # Seconds between each scan for new devices
    new_device_defaults:
      track_new_devices: false
      hide_if_away: false

################################################
## Group
################################################

group:

  presence_view:
    name: Presence
    view: yes
    entities:
      ## badges
      - alarm_control_panel.home
      - binary_sensor.ha_mode
      - sensor.ha_mode
      
      ## cards
      - group.ha_mode
      - group.family 
      - group.person_robert
      - group.person_monique
      - group.person_bjorn
      - group.vacation

  family:
    control: hidden
    entities:
      - group.person_robert
      - group.person_monique
      - group.person_bjorn

  person_robert:
    control: hidden
    entities:
      - device_tracker.robert_iphone
      - device_tracker.robert_owntracks

  person_monique:
    control: hidden
    entities:
      - device_tracker.monique_iphone

  person_bjorn:
    control: hidden
    entities:
      - device_tracker.bjorn_iphone

################################################
## Automation
################################################

automation:
  - alias: "Familie thuis"
    trigger:
      - platform: state
        entity_id: group.family
    action:
      - service: notify.admin
        data_template:
          message: >-
            {% set state = trigger.to_state.state %}
            {% if state == 'home' -%}
              Ik heb gemerkt dat er weer iemand thuis is.
            {%- elif state == 'not_home' -%}
              Ik zie dat er niemand meer thuis is.
            {%- else -%}
              Ik weet even niet of er iemand thuis is.            
            {%- endif %}

  - alias: "Notify New Device Detected"
    trigger:
      - platform: event
        event_type: device_tracker_new_device
    action:
      - service: persistent_notification.create
        data:
          message: "Nieuw apparaat herkend. Controleer bestand 'known_devices.yaml' voor details."
          title: "Nieuw apparaat"
      # - service: notify.admin
      #   data_template:
      #     message: "Nieuw apparaat herkend. Controleer bestand 'known_devices.yaml' voor details."
      #     title: "Nieuw apparaat"
