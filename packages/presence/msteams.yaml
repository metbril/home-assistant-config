---
# Monitoring of Microsoft Teams presence
#
# https://github.com/EBOOZ/TeamsStatus
#

##############################
# Input Texts
# https://www.home-assistant.io/integrations/input_text/
#
input_text:

  # This sensor gets updated by the remote REST POST script.
  # Inputs are intended as helpers, not for the UI
  #
  teams_status_person1:
    name: Microsoft Teams status person1
    icon: mdi:microsoft-teams

  # This sensor gets updated by the remote REST POST script.
  # Inputs are intended as helpers, not for the UI
  #
  teams_activity_person1:
    name: Microsoft Teams activity Persoon 1
    icon: mdi:microsoft-teams

##############################
# Sensors
# https://www.home-assistant.io/integrations/sensor/
#
sensor:

  - platform: template
    sensors:

      # Display teams status in the UI
      #
      teams_status_person1:
        friendly_name: "Microsoft Teams status Persoon 1"
        value_template: "{{states('input_text.teams_status_person1')}}"
        icon_template: "{{state_attr('input_text.teams_status_person1',
          'icon')}}"
        unique_id: sensor.teams_status_person1

      # Display teams activity in the UI
      #
      teams_activity_person1:
        friendly_name: "Microsoft Teams activity Persoon 1"
        value_template: "{{states('input_text.teams_activity_person1')}}"
        icon_template: "{{state_attr('input_text.teams_activity_person1',
          'icon')}}"
        unique_id: sensor.teams_activity_person1

  # How long user has been in call today
  #
  - platform: history_stats
    name: Microsoft Teams Call Time Today Person1
    entity_id: sensor.teams_activity_person1
    state: "In gesprek"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  # How many calls has user had today
  #
  - platform: history_stats
    name: Microsoft Teams Call Count Today Person1
    entity_id: sensor.teams_activity_person1
    state: "In gesprek"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  # How long has Teams been online on the laptop
  # Tracks any state other than Offline or Unknown
  #
  - platform: history_stats
    name: Microsoft Teams Online Today Person1
    entity_id: sensor.teams_status_person1
    state:
      - Beschikbaar
      - Bezet
      - Niet storen
      - Afwezig
      - Zo terug
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

##############################
# Binary Sensors
#
binary_sensor:

  - platform: template
    sensors:

      # Helper sensor for showing an icon in a badge
      #
      teams_status_person1:
        friendly_name: "Microsoft Teams status Persoon 1"
        value_template: >-
          {{   is_state('sensor.teams_status_person1', 'Beschikbaar')
            or is_state('sensor.teams_status_person1', 'Bezet')
            or is_state('sensor.teams_status_person1', 'Afwezig')
            or is_state('sensor.teams_status_person1', 'Zo terug')
            or is_state('sensor.teams_status_person1', 'Niet storen')
            or is_state('sensor.teams_status_person1', 'Offline') }}
        icon_template: >-
          {% if   is_state('sensor.teams_status_person1', 'Beschikbaar') %}
            mdi:account-check
          {% elif is_state('sensor.teams_status_person1', 'Bezet') %}
            mdi:account-off
          {% elif is_state('sensor.teams_status_person1', 'Afwezig') %}
            mdi:account-arrow-right
          {% elif is_state('sensor.teams_status_person1', 'Zo terug') %}
            mdi:account-clock
          {% elif is_state('sensor.teams_status_person1', 'Niet storen') %}
            mdi:account-cancel
          {% elif is_state('sensor.teams_status_person1', 'Offline') %}
            mdi:account-remove
          {% else %}
            mdi:account-question
          {% endif %}

##############################
# Templates
#
template:
  - binary_sensor:
      - name: Teams Online Person1
        unique_id: b1b5dd57-8102-4e86-b63c-88a9a2a67af9
        device_class: connectivity
        state: >
          {{ states('input_text.teams_status_person1') != 'Offline' and
             states('input_text.teams_status_person1') != 'unknown' }}

##############################
# Scenes
#
scene:

  # Turn off the status light
  #
  - name: Werk Beschikbaar
    id: e9d03c5e-e877-4aec-a976-e2622e641813
    icon: hass:account-check
    entities:
      light.werkstatus:
        state: 'off'

  # Turn on and set to red the status light
  # Turn off music
  #
  - name: Werk Niet Storen
    id: 7c19f66a-664e-42e8-9498-dc841c79a0e4
    icon: hass:account-cancel
    entities:
      light.werkstatus:
        brightness: 255
        rgb_color:
          - 255
          - 79
          - 70
        state: 'on'
      media_player.studeerkamer:
        state: paused

##############################
# Automations
#
automation:

  # Reset Teams Status Person1
  #
  - alias: Reset Teams Status Person1
    description: >
      Reset Teams Status when not changed for a long time outside
      work hours.

      This usually happens when you put your laptop in sleep or
      hibernate mode without closing the Teams application first.

      The status should not be reset if you just work outside of regular hours.

    id: aaff7435-8f79-4657-af57-454710cde9b9
    mode: single

    trigger:
      # Teams status has not changed for more than 2 hours
      #
      # TODO: This automation triggers every minute.
      #       Perhaps (re)set a timer for 2 hours on
      #       status change?
      platform: template
      value_template: >
        {{ as_timestamp(now()) -
           as_timestamp(states.input_text.teams_status_person1.last_changed) >
           2*3600 }}

    condition:
      # not a workday or after 18:00 ?
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.workday
            state: "off"
          - condition: time
            after: "18:00:00"

    action:
      - service: input_text.set_value
        data:
          entity_id: input_text.teams_status_person1
          value: unknown  # Don't use 'Offline' to differentiate
      - service: notify.robert
        data:
          message: Microsoft Teams status forced to 'Unknown'

  # Do Not Disturb
  #
  # Activate scene when Person1
  #   - is at home and
  #   - he's busy in Teams
  #
  - alias: Work - Do Not Disturb Person1
    description: >
      Show do not disturb when working from home and busy.

    id: e2ec598a-f7ac-48bc-b4db-173944e94bbe
    mode: single

    trigger:
      - platform: state
        entity_id: sensor.teams_status_person1

    condition:
      - condition: and
        conditions:
          - condition: state
            entity_id: person.person1
            state: home
          - condition: or
            conditions:
              - condition: state
                entity_id: sensor.teams_status_person1
                state: Bezet
              - condition: state
                entity_id: sensor.teams_status_person1
                state: Niet storen

    action:
      - scene: scene.werk_niet_storen

  # Person1 Available
  #
  - alias: Work - Person1 Available

    id: 4b82d606-f8c5-47bd-b1d4-17dd175a58be
    mode: single

    trigger:
      - platform: state
        entity_id: sensor.teams_status_person1

    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.teams_status_person1
            state: Bezet
          - condition: state
            entity_id: sensor.teams_status_person1
            state: Niet storen

    action:
      - scene: scene.werk_beschikbaar
