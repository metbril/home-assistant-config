############################################################################
## Packages / Security
############################################################################

homeassistant:
  customize:

    ########################################################################
    ## Node Anchors
    ########################################################################

    package.node_anchors:
      customize: &customize
        package: 'security'

      expose: &expose
        <<: *customize
        haaska_hidden: false
        homebridge_hidden: false

    ########################################################################
    ## Binary Sensor
    ########################################################################

    binary_sensor.motion_garage:
      <<: *customize
      friendly_name: "Beweging garage"
      device_class: motion

    binary_sensor.flamingo_remote_button_a:
      <<: *customize
      friendly_name: "Flamingo Afstandsbediening A"
      icon: mdi:remote

    ########################################################################
    ## Switch
    ########################################################################

    switch.frontdoor_bell:
      <<: *customize
      friendly_name: 'Bel voordeur'
      icon: mdi:bell-ring
      assumed_state: off

    switch.mess_call:
      <<: *customize
      friendly_name: 'Bel verzamelen'
      icon: mdi:bell-ring
      assumed_state: off

    ########################################################################
    ## Group
    ########################################################################

    group.security:
      <<: *customize
      friendly_name: 'Beveiliging'
      icon: mdi:security

############################################################################
## Group
############################################################################

group:
  security:
    name: Security
    view: yes
    entities:
      - alarm_control_panel.home
      - group.motion
      - group.contact

############################################################################
## Automation
############################################################################

automation:

  - alias: Frontdoor Bell Pressed
    initial_state: on
    trigger:
      - platform: event
        event_type: button_pressed
        event_data:
          entity_id: switch.frontdoor_bell
    action:
      - service: switch.turn_off
        entity_id: switch.frontdoor_bell
      - service: notify.all
        data_template:
          title: 'Bel voordeur'
          message: 'Er is aangebeld {{ as_timestamp(now()) | timestamp_custom("op %d-%m om %H:%M", True) }}'

  - alias: Mess Call Pressed
    initial_state: off
    trigger:
      - platform: event
        event_type: button_pressed
        event_data:
          entity_id: switch.mess_call
    action:
      - service: switch.turn_off
        entity_id: switch.mess_call
      - service: notify.all
        data:
          title: 'Etenstijd'
          message: 'Etenstijd!'

  # schakel de spanning van de garagedeur uit tussen 23:00 en 06:00
  - alias: Power off garage door after 23:00
    trigger:
      - platform: time
        at: '23:00:00'
    action:
      - service: switch.turn_off
        entity_id: switch.garage_door_plug_switch

  - alias: Power on garage door after 6:00
    trigger:
      - platform: time
        at: '06:00:00'
    condition:
      - condition: template
        value_template: "{{ states.sensor.ha_mode.state != 'vacation' }}"
    action:
      - service: switch.turn_on
        entity_id: switch.garage_door_plug_switch

  - alias: Turn On Dusk Living Lights
    trigger:
      - platform: sun
        event: sunset
        offset: "-00:30:00"
    action:
      - service: light.turn_on
        entity_id: group.dusk_living_lights
      - service: logbook.log
        data:
          name: Schemerverlichting woonkamer
          message: is ingeschakeld

  # schakel de verlichting uit tussen 23:00 en 23:30 als we op vakantie zijn
  - alias: Schakel verlichting uit als op vakantie
    trigger:
      - platform: time
        at: '23:00:00'
    condition:
      - condition: state
        entity_id: sensor.ha_mode
        state: 'vacation'
    action:
      # wacht tussen 0:0:0 en 0:29:59
      - delay: '{{ "0:" ~ ((range(0,29)|random)|int) ~ ":" ~ ((range(0,59)|random)|int) }}'
      - service: light.turn_off
        entity_id: group.dusk_living_lights
      - service: notify.all
        data_template:
          title: 'Vakantieschakeling.'
          message: 'Schermverlichting woonkamer automatisch uitgeschakeld.'

  - alias: Notify Vacation Enabled
    trigger:
      - platform: time
        at: '9:00:00'
    condition:
      - condition: state
        entity_id: sensor.ha_mode
        state: 'vacation'
    action:
      - service: notify.admin
        data_template:
          title: '**Vakantieschakeling**'
          message: 'Vakantiemodus nog ingeschakeld.'

# TODO: bark the dog when the doorbell rings