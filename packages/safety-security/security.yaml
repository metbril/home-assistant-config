############################################################################
## Packages / Security
############################################################################

homeassistant:
  customize:

    ########################################################################
    ## Node Anchors
    ########################################################################

    package.node_anchors:
      customize: &customize
        package: 'security'


############################################################################
## Group
############################################################################

group:
  security:
    name: Security
    view: yes
    entities:
      - alarm_control_panel.home
      - group.motion
      - group.contact

############################################################################
## Automation
############################################################################

automation:

  - alias: Frontdoor Bell Pressed
    initial_state: on
    trigger:
      - platform: event
        event_type: button_pressed
        event_data:
          entity_id: switch.frontdoor_bell
    action:
      - service: switch.turn_off
        entity_id: switch.frontdoor_bell
      - service: notify.all
        data_template:
          title: 'Bel voordeur'
          message: 'Er is aangebeld {{ as_timestamp(now()) | timestamp_custom("op %d-%m om %H:%M", True) }}'
      - service: notify.twitter
        data_template:
          message: >-
            {{ [
            "Oei, dat kietelt. Iemand drukte zojuist op mijn belletje.",
            "Au! Dat deed pijn. Wie raakte de deurbel aan?",
            "Dat deed een belletje bij me rinkelen.",
            "Klop, klop. Wie is daar? Isabel. Isabel wie? Isabel kapot. Daarom klop ik.",
            "Klop, klop. Wie is daar? Wil. Wil wie? Wil naar binnen.",
            "De bel gaat. Ja, ja, ik kom er aan.",
            "Doe even open @metbril. Er staat iemand aan de deur."
            ] | random + " #HomeAssistant" + [
            " #Security",
            " #Alarm",
            " #SmartHome",
            " #HomeAutomation"
            ] | random }}
          data:
            media: >-
              {% set pictures = [
                "/config/www/img/klopklop.jpg",
                "/config/www/img/deurklopper.png",
                "/config/www/img/aankloppen.jpg",
                "/config/www/img/deurbel.jpg",
              ] %}
              {{ pictures|random }}

  - alias: Mess Call Pressed
    initial_state: off
    trigger:
      - platform: event
        event_type: button_pressed
        event_data:
          entity_id: switch.mess_call
    action:
      - service: switch.turn_off
        entity_id: switch.mess_call
      - service: notify.all
        data:
          title: 'Etenstijd'
          message: 'Etenstijd!'

  # schakel de spanning van de garagedeur uit tussen 23:00 en 06:00
  - alias: Power off garage door after 23:00
    trigger:
      - platform: time
        at: '23:00:00'
    action:
      - service: switch.turn_off
        entity_id: switch.garage_door_plug_switch
      - service: logbook.log
        data:
          name: Schakelaar garagedeur
          message: is uitgeschakeld

  - alias: Power on garage door after 6:00
    trigger:
      - platform: time
        at: '06:00:00'
    condition:
      - condition: template
        value_template: "{{ states.sensor.ha_mode.state != 'vacation' }}"
    action:
      - service: switch.turn_on
        entity_id: switch.garage_door_plug_switch
      - service: logbook.log
        data:
          name: Schakelaar garagedeur
          message: is ingeschakeld

  - alias: Turn On Dusk Living Lights
    trigger:
      - platform: sun
        event: sunset
        offset: "-00:30:00"
    action:
      - service: light.turn_on
        entity_id: group.dusk_living_lights
      - service: logbook.log
        data:
          name: Schemerverlichting woonkamer
          message: is ingeschakeld
      - service: notify.twitter
        data_template:
          message: >-
            {{ [
            "Vlak voor zonsondergang doe ik de binnenverlichting aan.",
            "Ik doe de lampen aan, omdat het binnen donker gaat worden.",
            "Zodra de zon verdwijnt, doe ik de @TweetHue verlichting aan.",
            "De hoogste tijd om de verlichting in te schakelen."
            ] | random + " #HomeAssistant" + [
            " #Beveiliging",
            " #Zonsondergang",
            " #Verlichting",
            " #Hue",
            " #SmartLighting",
            " #SmartHome",
            " #HomeAutomation"
            ] | random }}
          # data:
          #   media: >-
          #     {% set pictures = [
          #       "/config/www/img/klopklop.jpg",
          #       "/config/www/img/deurklopper.png",
          #       "/config/www/img/aankloppen.jpg",
          #       "/config/www/img/deurbel.jpg",
          #     ] %}
          #     {{ pictures|random }}

  # schakel de verlichting uit tussen 23:00 en 23:30 als we op vakantie zijn
  - alias: Schakel verlichting uit als op vakantie
    trigger:
      - platform: time
        at: '23:00:00'
    condition:
      - condition: state
        entity_id: sensor.ha_mode
        state: 'vacation'
    action:
      # wacht tussen 0:0:0 en 0:29:0
      - delay: '{{ "0:" ~ ((range(0,29)|random)|int) ~ ":0" }}'
      - service: light.turn_off
        entity_id: group.dusk_living_lights
      - service: notify.admin
        data_template:
          title: 'Vakantiemodus'
          message: 'Schermverlichting woonkamer automatisch uitgeschakeld.'

  - alias: Notify Vacation Enabled
    trigger:
      - platform: time
        at: '9:00:00'
      - platform: state
        entity_id: sensor.ha_mode
        to: 'vacation'
    condition:
      - condition: state
        entity_id: sensor.ha_mode
        state: 'vacation'
    action:
      - service: notify.admin
        data_template:
          title: 'Vakantiemodus'
          message: 'Vakantiemodus is ingeschakeld'
