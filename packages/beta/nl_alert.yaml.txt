---
multiscrape:
  - name: NL-Alert
    resource: https://crisis.nl/nl-alert/nl-alerts/
    scan_interval: 60  # seconds
    sensor:
      - unique_id: nl_alert  # entity_id
        name: NL-Alert
        device_class: timestamp
        select: "#content > div:nth-child(4) > a > h3"
        value_template: |
          {% set upper_value = (value | upper) %}
          {% set stripped_value = upper_value.split('ACTIEF')[-1].strip() if 'ACTIEF' in upper_value else value.strip() %}
          {{ (strptime(stripped_value, "%d-%m-%Y %H:%M:%S", "unavailable") | as_local).isoformat() }}
        attributes:
          - name: Headline
            select: "#content > div:nth-child(4) > a > h3"
          - name: Melding
            select: "#content > div:nth-child(4) > a > p"
          - name: Meer informatie
            select: "#content > div:nth-child(4) > a"
            attribute: href
    binary_sensor:
      - unique_id: nl_alert_actief  # entity_id
        name: NL-Alert Actief
        device_class: safety
        select: "#content > div:nth-child(4) > a > h3"
        value_template: |
          {{ "ACTIEF" in (value | upper) }}
      - unique_id: nl_alert_test  # entity_id
        name: NL-Alert Testbericht
        select: "#content > div:nth-child(4) > a > p"
        value_template: |
          {{ "TESTBERICHT" in (value | upper) }}

  - name: NL-Alert Detail
    resource_template: "https://www.crisis.nl{{ state_attr('sensor.nl_alert', 'meer_informatie') }}"
    scan_interval: 3600  # seconds
    button:
      unique_id: nl_alert_kaart_verversen
      name: NL-Alert Kaart verversen
    sensor:
      - unique_id: nl_alert_kaart  # entity_id
        name: NL-Alert Kaart
        value_template: "OK"
        attributes:
          - name: URL
            select: "div#main > div.wrapper > div.googlemaps > img"
            attribute: src

automation:
  - alias: Safety > Refresh NL Alert Map
    id: 67f176af-32db-4bb4-981e-6c063bc8ce32
    mode: single
    trigger:
      - platform: state
        entity_id:
          - sensor.nl_alert
      - platform: homeassistant
        event: start
    condition: []
    action:
      - service: multiscrape.trigger_nl_alert_detail
