---
##################################################
# Packages / System / Host
##################################################

homeassistant:
  customize:

    ##################################################
    # Binary sensors
    ##################################################

    binary_sensor.cpu_high:
      device_class: problem
      friendly_name: CPU Hoog
    binary_sensor.cpu_hot:
      device_class: heat
      friendly_name: CPU Heet
    binary_sensor.db_large:
      device_class: problem
      friendly_name: Grote database

    ##################################################
    # Sensors
    ##################################################

    sensor.bad_login:
      friendly_name: Mislukte inlogpogingen
      icon: hass:alert
    sensor.sensor.processor_temperature:
      friendly_name: Processortemperatuur
    sensor.ha_uptime:
      friendly_name: Sinds laatste start HA
      icon: hass:clock
    sensor.homeassistant_v2db:
      friendly_name: Grootte database
    sensor.homeassistantlog:
      friendly_name: Grootte logbestand

    sensor.last_restart:
      device_class: timestamp
      friendly_name: Laatste herstart

##################################################
## Binary Sensor
##################################################

binary_sensor:

  - platform: template
    sensors:
      cpu_high:
        value_template: "{{states('sensor.processor_use')|float>80}}"

      cpu_hot:
        value_template: "{{states('sensor.processor_temperature')|float>80}}"

      db_large:
        value_template: "{{states('sensor.home_assistant_v2_db')|float>3000}}"

##################################################
## Sensor
##################################################
sensor:
  - platform: systemmonitor
    resources:
      - type: memory_use_percent
      - type: processor_use
      - type: processor_temperature
      - type: last_boot

      - type: disk_use_percent
        arg: /

      - type: disk_free
        arg: /

      - type: ipv4_address
        arg: 'eth0'

      - type: ipv6_address
        arg: 'eth0'

      - type: network_in
        arg: 'eth0'

      - type: network_out
        arg: 'eth0'

      - type: throughput_network_in
        arg: 'eth0'

      - type: throughput_network_out
        arg: 'eth0'

      - type: packets_in
        arg: 'eth0'

      - type: packets_out
        arg: 'eth0'

  - platform: filesize
    file_paths:
      - !secret filesize_homeassistant_db
      - !secret filesize_homeassistant_log

  - platform: command_line
    name: Last Restart
    # yamllint disable-line rule:line-length
    command: date "+%Y-%m-%dT%H:%M:%S%z" -d "$(head -n1 /config/home-assistant.log | cut -d' ' -f-2)"
    value_template: '{{ value }}'

  - platform: command_line
    name: bad_login
    command: "grep -c 'Login attempt' /config/home-assistant.log"
    value_template: '{{ value | int - 1 }}'

  - platform: command_line
    # https://home-assistant.io/components/sensor.command_line/
    name: "HA Uptime"
    # yamllint disable-line rule:line-length
    command: echo "$(($(date +%s) - $(date -d "$(head -n1 /config/home-assistant.log | cut -d' ' -f-2)" +%s)))"
    scan_interval: 60  # seconds
    value_template: >-
      {% set uptime = value | int %}
      {% set seconds = uptime % 60 %}
      {% set minutes = ((uptime % 3600) / 60) | int %}
      {% set hours = ((uptime % 86400) / 3600) | int %}
      {% set days = (uptime / 86400) | int %}
      {% if days > 0 %}
        {% if days == 1 %}
          1 day
        {% else %}
          {{ days }} days
        {% endif %}
        {{ ', ' }}
      {% endif %}
      {{ '%02d' % hours }}:{{ '%02d' % minutes }}

################################################
## Alert
################################################

alert:
  cpu_high:
    name: Gebruik CPU is hoog
    entity_id: binary_sensor.cpu_high
    state: 'on'
    repeat: 5  # minutes
    can_acknowledge: true
    skip_first: false
    notifiers:
      - admin

  cpu_hot:
    name: Processortemperatuur is te hoog
    entity_id: binary_sensor.cpu_hot
    state: 'on'
    repeat: 5  # minutes
    can_acknowledge: true
    skip_first: false
    notifiers:
      - admin

  db_large:
    name: Database Large
    entity_id: binary_sensor.db_large
    state: 'on'
    repeat:  # minutes
      - 15
      - 30
      - 60
      - 120
      - 240
    can_acknowledge: true
    skip_first: false
    notifiers:
      - admin
