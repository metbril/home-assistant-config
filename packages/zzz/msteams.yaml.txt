---
# Monitoring of Teams presence
#
# https://github.com/EBOOZ/TeamsStatus
#
homeassistant:
  customize:
    sensor.msteams_call_time_today_robert:
      friendly_name: Teams Call Time Today Robert
    sensor.msteams_call_count_today_robert:
      friendly_name: Teams Call Count Today Robert
    sensor.msteams_online_today_robert:
      friendly_name: Teams Online Today Robert

##############################
# Input Texts
# https://www.home-assistant.io/integrations/input_text/
#
input_text:

  # This sensor gets updated by the remote REST POST script.
  # Inputs are intended as helpers, not for the UI
  #
  msteams_status_robert:
    name: Teams status Robert
    icon: mdi:microsoft-teams

  # This sensor gets updated by the remote REST POST script.
  # Inputs are intended as helpers, not for the UI
  #
  msteams_activity_robert:
    name: Teams activity Robert
    icon: mdi:microsoft-teams

##############################
# Sensors
# https://www.home-assistant.io/integrations/sensor/
#
sensor:

  - platform: template
    sensors:

      # Display teams status in the UI
      #
      msteams_status_robert:
        friendly_name: "Teams status Robert"
        value_template: "{{states('input_text.msteams_status_robert')}}"
        icon_template: "{{state_attr('input_text.msteams_status_robert',
          'icon')}}"
        unique_id: sensor.msteams_status_robert

      # Display teams activity in the UI
      #
      msteams_activity_robert:
        friendly_name: "Teams activity Robert"
        value_template: >-
          {{states('input_text.msteams_activity_robert')}}
        icon_template: >-
          {{state_attr('input_text.msteams_activity_robert',
          'icon')}}
        unique_id: sensor.msteams_activity_robert

  # How long user has been in call today
  #
  - platform: history_stats
    name: MSTeams Call Time Today Robert
    entity_id: sensor.msteams_activity_robert
    state: "In gesprek"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  # How many calls has user had today
  #
  - platform: history_stats
    name: MSTeams Call Count Today Robert
    entity_id: sensor.msteams_activity_robert
    state: "In gesprek"
    type: count
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

  # How long has Teams been online on the laptop
  # Tracks any state other than Offline or Unknown
  #
  - platform: history_stats
    name: MSTeams Online Today Robert
    entity_id: binary_sensor.msteams_online_robert
    state:
      - "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"

##############################
# Binary Sensors
#
binary_sensor:

  - platform: template
    sensors:

      # Helper sensor for showing an icon in a badge
      #
      msteams_status_robert:
        friendly_name: "Teams status Robert"
        value_template: >-
          {% set status = states('sensor.msteams_status_robert') %}
          {% set list = [
            'Beschikbaar',
            'Bezet',
            'In een vergadering',
            'Aan de telefoon',
            'Afwezig',
            'Zo terug',
            'Niet storen',
            'Presenteren',
            'Focussen',
            'Offline'] %}
          {{ status in list }}
        icon_template: >-
          {% set status = states('sensor.msteams_status_robert') %}
          {% set list = [
            'Beschikbaar',
            'Bezet',
            'In een vergadering',
            'Aan de telefoon',
            'Afwezig',
            'Zo terug',
            'Niet storen',
            'Presenteren',
            'Focussen',
            'Offline'
            ] %}
          {% set icons = [
            'mdi:account-check',
            'mdi:account-off',
            'mdi:account-group',
            'mdi:account-voice',
            'mdi:account-arrow-right',
            'mdi:account-clock',
            'mdi:account-cancel',
            'mdi:account-eye',
            'mdi:account-alert',
            'mdi:account-remove'
            ] %}
          {% if status in list %}
           {{ icons[list.index(status)] }}
          {% else %}
            mdi:account-question
          {% endif %}

##############################
# Templates
#
template:
  - binary_sensor:
      - name: MSTeams Online Robert
        unique_id: b1b5dd57-8102-4e86-b63c-88a9a2a67af9
        device_class: connectivity
        state: >
          {{ (not is_state('input_text.msteams_status_robert','Offline')) and
             (not is_state('input_text.msteams_status_robert','unknown')) }}

##############################
# Scenes
#
scene:

  # Turn off the status light
  #
  - name: Werk Beschikbaar
    id: e9d03c5e-e877-4aec-a976-e2622e641813
    icon: hass:account-check
    entities:
      light.werkstatus:
        state: 'off'

  # Turn on and set to red the status light
  # Turn off music
  #
  - name: Werk Niet Storen
    id: 7c19f66a-664e-42e8-9498-dc841c79a0e4
    icon: hass:account-cancel
    entities:
      light.werkstatus:
        brightness: 255
        rgb_color:
          - 255
          - 79
          - 70
        state: 'on'
      media_player.studeerkamer:
        state: paused

##############################
# Automations
#
automation:

  # Reset Teams Status Robert
  #
  - alias: Reset Teams Status Robert
    description: >
      Reset Teams Status when not changed for a long time outside
      work hours.

      This usually happens when you put your laptop in sleep or
      hibernate mode without closing the Teams application first.

      The status should not be reset if you just work outside of regular hours.

    id: aaff7435-8f79-4657-af57-454710cde9b9
    mode: single

    trigger:
      # Teams status has not changed for more than 1 hours
      #
      # TODO: This automation triggers every minute.
      #       Perhaps (re)set a timer for 1 hours on
      #       status change?
      platform: template
      value_template: >
        {{ as_timestamp(now()) -
           as_timestamp(
             states.input_text.msteams_status_robert.last_changed
             ) > 1*3600 }}

    condition:
      # not a workday or after 18:00 ?
      - condition: or
        conditions:
          - condition: state
            entity_id: binary_sensor.workday
            state: "off"
          - condition: time
            after: "18:00:00"

      - condition: not
        conditions:
          - condition: state
            entity_id: input_text.msteams_status_robert
            state: unknown

    action:
      - service: input_text.set_value
        data:
          entity_id: input_text.msteams_status_robert
          value: unknown  # Don't use 'Offline' to differentiate
      - service: input_text.set_value
        data:
          entity_id: input_text.msteams_activity_robert
          value: unknown

      - service: notify.robert
        data:
          message: Teams status opnieuw ingesteld door inactiviteit.

  # Do Not Disturb
  #
  # Activate scene when Robert
  #   - is at home and
  #   - he's busy in Teams
  #
  - alias: Work - Do Not Disturb Robert
    description: >
      Show do not disturb when working from home and busy.

    id: e2ec598a-f7ac-48bc-b4db-173944e94bbe
    mode: single

    trigger:
      - platform: state
        entity_id: sensor.msteams_status_robert

    condition:
      - condition: and
        conditions:
          - condition: state
            entity_id: person.robert
            state: home
          - condition: or
            conditions:
              - condition: state
                entity_id: sensor.msteams_status_robert
                state: Bezet
              - condition: state
                entity_id: sensor.msteams_status_robert
                state: Niet storen

    action:
      - scene: scene.werk_niet_storen

  # Robert Available
  #
  - alias: Work - Robert Available

    id: 4b82d606-f8c5-47bd-b1d4-17dd175a58be
    mode: single

    trigger:
      - platform: state
        entity_id: sensor.msteams_status_robert

    condition:
      - condition: not
        conditions:
          - condition: state
            entity_id: sensor.msteams_status_robert
            state: Bezet
          - condition: state
            entity_id: sensor.msteams_status_robert
            state: Niet storen

    action:
      - scene: scene.werk_beschikbaar
