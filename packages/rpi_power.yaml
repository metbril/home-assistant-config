################################################
## Packages / RPI Power
################################################

homeassistant:
  customize:
    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'rpi_power'

    ################################################
    ## Binary Sensor
    ################################################
    binary_sensor.rpi_power_issue:
      device_class: problem
      friendly_name: RPi Voeding

################################################
## Binary Sensor
################################################

binary_sensor:
  - platform: template
    sensors:
      rpi_power_issue:
        value_template: >-
          {{ not is_state_attr("sensor.rpi_power_status", "value", "0") }}

################################################
## Alert
################################################

alert:
  rpi_power_issue:
    name: RPi Power Issue
    entity_id: binary_sensor.rpi_power_issue
    state: 'on' # Optional, default value is 'on'
    repeat: 
      - 15
      - 30
      - 60
      - 120
    can_acknowledge: true # Optional, default value is true
    skip_first: false # Optional, default value is false
    notifiers:
      - admin
    message: >-
      Er is een probleem met de RPi-voeding.\n\n{{ states("sensor.rpi_power_status") }}
    done_message: >-
      Het probleem met de RPi-voeding is verholpen.

################################################
## Automation
################################################
automation:

  - alias: RPi Power Issue Notification
    trigger:
    - platform: numeric_state
      entity_id: sensor.rpi_power_status
      value_template: '{{ state.attributes.value }}'
      above: 0
      for:
        minutes: 5
    condition: []
    action:
    - service: persistent_notification.create
      data_template:
        message: "De systeemvoeding meldt: '{{ states.sensor.rpi_power_status.state }}'. De vorige status was '{{ trigger.from_state.state }}' "
        title: Systeemvoeding
