################################################
## Packages Template
################################################

homeassistant:
  customize:

    ################################################
    ## Node Anchors
    ################################################

    package.node_anchors:
      customize: &customize
        package: 'zwave'

    ################################################
    ## Zwave
    ################################################

    zwave.charging_station_plug:
      <<: *customize
      friendly_name: Oplaadstation

    zwave.garage_door_plug:
      <<: *customize
      friendly_name: Garagedeur

    ################################################
    ## Switch
    ################################################

    sensor.charging_station_plug_power:
      <<: *customize
      friendly_name: Verbruik oplaadstation
      icon: mdi:flash

    sensor.garage_door_plug_power:
      <<: *customize
      friendly_name: Verbruik garagedeur
      icon: mdi:flash

    ################################################
    ## Switch
    ################################################

    switch.charging_station_plug_switch:
      <<: *customize
      friendly_name: Oplaadstation
      icon: mdi:power

    switch.garage_door_plug_switch:
      <<: *customize
      friendly_name: Garagedeur
      icon: mdi:power

    ################################################
    ## Group
    ################################################

    group.zwave:
      <<: *customize
      friendly_name: Z-Wave
      icon: mdi:nfc

    ################################################
    ## Script
    ################################################

    script.reset_energy_meters:
      <<: *customize
      friendly_name: 'Opnieuw instellen Z-Wave Energiemeters'
    
    ################################################
    ## Automation
    ################################################

    automation.switch_off_charging_station:
      <<: *customize
      friendly_name: 'Uitschakelen oplaadstation'

################################################
## Group
################################################

group:
  zwave:
    name: 'Z-Wave Devices'
    entities:
      - zwave.controller_1
      - zwave.fibaro_wall_plug_7
      - zwave.charging_station_plug
      - zwave.benext_molite_8
      - zwave.master_bedroom_outside_door

  fibaro_wall_plug_7:
    name: 'Fibaro Wall Plug (Node 7)'
    entities:
      - switch.fibaro_wall_plug_7
      - sensor.fibaro_wall_plug_7_energy
      - sensor.fibaro_wall_plug_7_power
      - sensor.fibaro_wall_plug_7_power_2
      - sensor.fibaro_wall_plug_7_exporting
      - zwave.fibaro_wall_plug_7

################################################
## Script
################################################

script:
  reset_energy_meters:
    sequence:
      - service: zwave.reset_node_meters
        data: { "node_id": "7", "instance":"1" }
      - service: logbook.log
        data:
          name: Energiemeters
          message: opniew ingesteld

################################################
## Automation
################################################

automation:
  - alias: Reset Energy Meters Monthly
    hide_entity: no
    initial_state: on
    trigger:
      - platform: time
        # upgrade to 0.90
        # hours: 00
        # minutes: 00
        # seconds: 00
        at: '00:00:00'
    condition:
      - condition: template
        value_template: "{{ now().date().day == 1 }}"
    action:
      - service: script.reset_energy_meters
      - service: logbook.log
        data:
          name: Energiemeters
          message: automatisch gereset voor start maand

  - alias: Switch Off Charging Station 
    initial_state: off
    trigger:
      ## Charging is done when consumption is below 5W for 1 minute
      - platform: numeric_state
        entity_id: sensor.charging_station_plug_power
        below: 5
        for:
          minutes: 10
    action:
      - service: switch.turn_off
        entity_id: switch.charging_station_plug_switch
      - service: logbook.log
        data:
          name: Oplaadstation
          message: automatisch uitgeschakeld door inactiviteit
          entity_id: switch.charging_station_plug_switch
          domain: switch
