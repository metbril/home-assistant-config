---
# Fuel package

homeassistant:
  customize_glob:
    sensor.diesel_*:
      icon: mdi:gas-station
      unit_of_measurement: €/L
    sensor.euro95_*:
      icon: mdi:gas-station
      unit_of_measurement: €/L
    sensor.lpg_*:
      icon: mdi:gas-station
      unit_of_measurement: €/L

sensor:

  # Brandstofprijzen custom component
  # https://github.com/metbril/home-assistant-brandstofprijzen
  #
  # I keep this sensor, to check if it keeps working with HA
  #
  - platform: brandstofprijzen

  # --- scrape sensors ---

  - platform: scrape
    name: Euro95 (Lukoil Schermerhoek)
    resource: "http://lukoil.nl/go/lukoil_station.cfm?id=465"
    select: "#tabbedInfoContent div.tab:nth-of-type(2) .priceBox2 .price"
    value_template: "{{ value|replace('EUR/L', '')|float|round(3) }}"
    scan_interval: 3600  # be nice; once per hour only

  - platform: scrape
    name: Euro95 (Tango Hoofdweg)
    # yamllint disable-line rule:line-length
    resource: "https://www.tango.nl/stations/tango-capelle-aan-den-ijssel-hoofdweg"
    select: "div#euro95 div.pump_price span.price"
    scan_interval: 3600  # be nice; once per hour only

  - platform: scrape
    name: Euro95 (Tinq Bermweg)
    resource: "https://www.tinq.nl/tankstations/capelle-ad-ijssel-bermweg"
    # yamllint disable-line rule:line-length
    select: ".field--name-field-station-prices .taxonomy-term-Euro95 .field--name-field-prices-price-pump"
    value_template: >
      {{ value | replace('€','') | replace('EUR/L','') | float | round(3) }}
    scan_interval: 3600  # be nice; once per hour only

  # --- OCR sensors ---

  # Get fuel prices through OCR
  # The free OCR API is limited to 500 call/day AND 25000 requests per month.
  # Documentation at https://ocr.space/OCRAPI
  #
  # Since the API key is personal, the full call needs to be in secrets.yaml
  #
  # Base URL
  # https://api.ocr.space/parse/ImageUrl?apikey=APIKEY&language=dut&isTable=true&scale=true&url=IMAGEURL?lang=nl
  #

  # https://tankservice.app-it-up.com/Tankservice/v2/places/2318.png?lang=nl
  # https://directlease.nl/tankservice/
  - platform: rest
    name: Brandstoffen Dijktank Kanaalweg
    resource: !secret ocr_api_dijktank
    method: GET
    scan_interval: 3600  # seconds: 1h=3600 / 2h=7200 / 3h=10800 / 4h=14400 / 6h=21600 / 8h=28800 / 12h=43200
    value_template: "OK"  # the default  returned json would exceed 255 character limit
    json_attributes:
      - ParsedResults

  # https://tankservice.app-it-up.com/Tankservice/v2/places/2248.png?lang=nl
  # https://directlease.nl/tankservice/
  - platform: rest
    name: Brandstoffen Tamoil Ommoord
    # yamllint disable-line rule:line-length
    resource: !secret ocr_api_ommoord
    method: GET
    # 1h=3600 / 2h=7200 / 3h=10800 / 4h=14400 / 6h=21600 / 8h=28800 / 12h=43200
    scan_interval: 3600  # seconds
    value_template: "OK"  # returned json exceeds 255 char. limit
    json_attributes:
      - ParsedResults

template:

  # These sensors extract the fuel price from the OCR'ed prices
  # Done in 2 steps, so only 1 API call per station is required.
  # Can be done in 1 sensor if only 1 fuel type is needed.

  - sensor:
      - name: "Euro95 (Dijktank Kanaalweg)"
        state: >
          {{ state_attr(
            'sensor.brandstoffen_dijktank_kanaalweg',
            'ParsedResults')[0]['ParsedText'].split('\r\n')[3].split('€')[1]
            | replace(',', '.') | float }}

      - name: "Euro95 (Tamoil Ommoord)"
        state: >
          {{ state_attr(
            'sensor.brandstoffen_tamoil_ommoord',
            'ParsedResults')[0]['ParsedText'].split('\t\r\n')[4].split('€')[1]
            | replace(',', '.') | float(None) }}

automation:

  - alias: Euro95 gewijzigd
    description: 'Notification for updated Euro95 fuel prices'

    id: cea83bd6-bc1a-4973-b080-8ed2bb9a3026
    mode: queued

    trigger:
      - platform: state
        entity_id:
          - sensor.adviesprijs_euro95
          - sensor.euro95_dijktank_kanaalweg
          - sensor.euro95_lukoil_schermerhoek
          # - sensor.euro95_sakko_metaalhof
          - sensor.euro95_tamoil_ommoord
          - sensor.euro95_tango_hoofdweg
          - sensor.euro95_tinq_bermweg

    condition:
      - condition: template
        value_template: "{{ trigger.to_state.state not in [None, 'unknown','unavailable'] }}"

    action:
      - service: notify.robert
        data:
          message: >
            {{ state_attr(trigger.entity_id,'friendly_name') }}
            is gewijzigd naar
            {{ trigger.to_state.state }}
            {{ state_attr(trigger.entity_id,'unit_of_measurement')}}.
