############################################################################
## Packages / Host / Updates
############################################################################

homeassistant:
  customize:
    ########################################################################
    ## Node Anchors
    ########################################################################

    package.node_anchors:
      customize: &customize
        package: 'updates'

    ########################################################################
    ## Binary Sensor
    ########################################################################

    binary_sensor.ha_update_available:
      <<: *customize
      friendly_name: 'Update Beschikbaar voor HA'
      device_class: safety

    ########################################################################
    ## Sensor
    ########################################################################

    sensor.ha_installed_version:
      <<: *customize
      friendly_name: 'GeÃ¯nstalleerde versie HA'
      icon: mdi:approval

    sensor.ha_current_stable_version:
      <<: *customize
      friendly_name: 'Huidige stabiele versie HA'
      icon: mdi:approval

    sensor.ha_current_beta_version:
      <<: *customize
      friendly_name: 'Huidige beta versie HA'
      icon: mdi:beta

    ########################################################################
    ## Group
    ########################################################################

    group.host_updates:
      <<: *customize
      friendly_name: 'HA Host Updates'
      icon: mdi:sync

    ########################################################################
    ## Updater
    ########################################################################

    updater.updater:
      <<: *customize
      friendly_name: 'HA Update Beschikbaar'
      icon: mdi:sync

    ########################################################################
    ## Automation
    ########################################################################

    automation.ha_update_available_notification:
      <<: *customize
      friendly_name: 'HA Update Beschikbaar Melding'
      icon: mdi:sync

    automation.ha_update_available_for_hassio_notification:
      <<: *customize
      friendly_name: 'HA Update Beschikbaar Melding'
      icon: mdi:sync

############################################################################
## Updater
## https://www.home-assistant.io/components/updater/
## https://www.home-assistant.io/docs/backend/updater/
############################################################################

updater:
  reporting: true # collect basic information about this instance and its environment
  include_used_components: true # report components to developers

############################################################################
## Binary Sensor
############################################################################

binary_sensor:
  - platform: template
    sensors:
      ha_update_available:
        value_template: >-
          {{ states.sensor.ha_current_stable_version.state != states.sensor.ha_installed_version.state and
             states.sensor.ha_current_stable_version.state != 'unavailable' }}

############################################################################
## Sensor
############################################################################

sensor:
  - platform: version
    name: HA Installed Version

  - platform: rest
    resource: https://s3.amazonaws.com/hassio-version/stable.json
    name: HA Current Stable Version
    value_template: '{{ value_json.homeassistant.default }}'

  - platform: rest
    resource: https://s3.amazonaws.com/hassio-version/beta.json
    name: HA Current Beta Version
    value_template: '{{ value_json.homeassistant.default }}'

############################################################################
## Group
############################################################################

group:
  host_updates:
    name: 'Updates'
    entities:
      - updater.updater
      - sensor.ha_current_beta_version
      - sensor.ha_current_stable_version
      - sensor.ha_installed_version
      - binary_sensor.ha_update_available
      - sensor.ha_update_available

############################################################################
## Automation
############################################################################

automation:
  - alias: 'HA Update Available Notification'
    trigger:
      - platform: state
        entity_id: updater.updater
    action:
      - service: notify.admin
        data:
          message: 'Update voor Home Assistant beschikbaar.'

  - alias: 'HA Update Available for Hass.io Notification'
    trigger:
      - platform: template
        value_template: >-
          {{ states.sensor.ha_current_stable_version.state != states.sensor.ha_installed_version.state and
             states.sensor.ha_current_stable_version.state != 'unavailable' }}
    action:
      - service: notify.admin
        data:
          message: 'Home Assistant versie {{ states.sensor.ha_current_stable_version.state }} is nu beschikbaar voor HASS.io'
          title: Home Assistant Update
