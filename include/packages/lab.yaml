######################################################################
## Lab
## @description : A package with some experimental features
## @author      : Robert van Bregt (metbril)
######################################################################

homeassistant:

  customize:
    package.node_anchors:
      customize: &customize
        package: 'lab'

# Sign - a set of configuration items to show a signpost. 
# This is a color light bulb that changes color according to the day of the year.
# The signpost switches ON at sunset and OFF at sunrise.

# Christmas: alternate green and red light every 15 minutes, smooth transition
# King's Day: orange from sunset before until the sunrise the day after (effectively two nights)

## Basicly save the sign type every hour (once a day should do) to a template sensor

input_boolean:
  signpost_manual:
    name: Signpost Manual
    initial: off

# This date will overwrite 'today' when the input switch is on
# For debugging and testing.
input_datetime:
  signpost_date:
    name: Signpost Date
    has_date: true
    has_time: false

sensor:

  ################################################################################
  # Holidays for Netherlands: https://www.webcal.fi/nl-NL/feestdagen.php
  # More info: https://www.webcal.fi/en/other_file_formats.php
  # Update every 14400 seconds (4 hours)
  ################################################################################
  - platform: rest
    resource: https://www.webcal.fi/cal.php?id=111&format=json&start_year=current_year&end_year=current_year&tz=Europe%2FAmsterdam
    name: Holiday
    scan_interval: 14400
    value_template: >-
      {%- set now_string = now().strftime('%Y-%m-%d') -%}
      {%- if (is_state('input_boolean.signpost_manual', 'on')) -%}
        {%- set now_string = states('input_datetime.signpost_date') -%}
      {%- endif -%}
      {%- for day_val in value_json if day_val.date == now_string -%}
          {{ day_val.name }}
      {%- endfor -%}

  ################################################################################
  # Flag days for Netherlands: https://www.webcal.fi/nl-NL/vlag_dagen.php
  # More info: https://www.webcal.fi/en/other_file_formats.php
  # Update every 14400 seconds (4 hours)
  ################################################################################
  - platform: rest
    resource: https://www.webcal.fi/cal.php?id=482&format=json&start_year=current_year&end_year=current_year&tz=Europe%2FAmsterdam
    name: Flag
    scan_interval: 14400
    value_template: >-
      {%- set now_string = now().strftime('%Y-%m-%d') -%}
      {%- for day_val in value_json if day_val.date == now_string -%}
          {{ day_val.name }}
      {%- endfor -%}

#   - platform: template
#     sensors:

#       signpost_event:
#         friendly_name: "Sign Type"
#         value_template: >
#           {% set today = xxx %}
#           {% if today >= '1225' and today <= '1226' %}
#             christmas
#           {% else %}
#             default
#           {% end %}

automation:
  - alias: Switch On Signpost Light
    trigger:
      - platform: sun
        event: sunset
      - platform: state
        entity_id: input_boolean.signpost_manual
        to: "on"
    action:
      - service: light.turn_on
        entity_id: light.tv_meubel
      - service: logbook.log
        data:
          name: Signpost lamp
          message: is ingeschakeld

  - alias: Switch Off Signpost Light
    trigger:
      - platform: sun
        event: sunrise
      - platform: state
        entity_id: input_boolean.signpost_manual
        to: "off"
    action:
      - service: light.turn_off
        entity_id: light.tv_meubel
      - service: logbook.log
        data:
          name: Signpost lamp
          message: is uitgeschakeld
