---
# -------------------------------------------
# Scripts to send notifications to Twitter
# Original Repo : https://github.com/CCOSTAN/Home-AssistantConfig
# -------------------------------------------
#


sensor:
  - platform: rest
    resource: https://cdn.syndication.twimg.com/widgets/followbutton/info.json?screen_names=DomusSapiens
    value_template: '{{ value_json[0]["followers_count"] | int(0) }}'


############################################################
# Automations
#
# Some ideas from:
# https://github.com/CCOSTAN/Home-AssistantConfig
############################################################
automation:

  - alias: 'Random House stats'
    id: b274a40d-cb67-4d6a-94d1-5fa685ae5ea4
    initial_state: true
    mode: single

    trigger:
      - platform: time_pattern
        hours: "/2"

    condition: []

    action:
      - delay: '0{{range(0,1)|random|int}}:{{range(0,5)|random|int}}{{range(0,9)|random|int }}:{{range(0,5)|random|int}}{{range(0,9)|random|int}}'
      - variables:
          pick: >-
            {{ [
              "robot",
              "door",
              "weather",
              "host",
              "speedtest",
              "internet",
              "promo"
            ] | random }}
          message: >-
            {%- macro relative(dt) -%}
              {{ relative_time(dt)
                .replace('years','jaren')
                .replace('year','jaar')
                .replace('months',',maanden')
                .replace('month','maand')
                .replace('days','dagen')
                .replace('day','dag')
                .replace('hours','uren')
                .replace('hour','uur')
                .replace('minutes','minuten')
                .replace('minute','minuut')
                .replace('seconds','seconden')
                .replace('second','seconde')
              }}
            {%- endmacro -%}
            {{ {
              "promo": [
                "Jij kunt van je huis ook een #smarthome maken. Alles wat je nodig hebt is #HomeAssistant, wat tijd en wat configuratiebestanden. Neem daarvoor een kijkje in mijn GitHub repo. (https://github.com/metbril/home-assistant-config)",
                "Je kunt bekijken hoe dit alles is gedaan door te bladeren door mijn GitHub repository. (https://github.com/metbril/home-assistant-config)",
                "Meld je aan voor onze repository met nu al {{ states.sensor.github_stats.attributes.stargazers_count}} andere gebruikers. Bekijk de {{ states.sensor.github_stats.attributes.open_issues }} open taken. (https://github.com/metbril/home-assistant-config)",
                "Mijn Github code heeft {{ states.sensor.github_stats.attributes.stargazers_count}} sterren 🌟 en loopt op.  Nu met {{ states.sensor.github_stats.attributes.open_issues }} open taken. (https://github.com/metbril/home-assistant-config)",
                "Zorg dat je onze 🐦 Twitter-accounts @robertvanbregt en @DomusSapiens volgt!"
              ],
              "robot": [
                "Biep-bop-biep-boep. Ik ben een #roBOT 🤖 bestuurd door @robertvanbregt",
                "Home Assistant is beschikbaar sinds {{ relative(as_datetime(states('sensor.uptime'))) }} ⏱. (https://github.com/metbril/home-assistant-config)",
                "Home Assistant gebruikt momenteel {{ states('sensor.disk_use_percent') }}% van de harde schijf. (https://github.com/metbril/home-assistant-config)",
                "Ik draai op Home Assistant versie {{ states('sensor.ha_installed_version') }} (https://github.com/metbril/home-assistant-config)",
                "{{ states('sensor.lines_of_code') }} regels met Home Assistant configuratie draait sinds {{ states('sensor.uptime') }}. (https://github.com/metbril/home-assistant-config)",
                "Het Domus Sapiens huis draait nu op {{ states('sensor.lines_of_code') }} regels YAML-code.  Neem een kijkje bij (https://github.com/metbril/home-assistant-config)",
                "{{ ((states('sensor.count_sensors') | int) + (states('sensor.count_binary_sensors') | int)) }} sensoren voeden mijn Smart Home. (https://github.com/metbril/home-assistant-config)",
                "{{ states('sensor.count_automations')}} automatiseringen en {{states('sensor.count_scripts')}} scripts maken mijn huis slim. (https://github.com/metbril/home-assistant-config)",
                "Let maar niet op mij.  Ik hou alleen maar {{states.sensor.lights_count.state}} lights en{{states.sensor.tracker_count.state}} apparaten in huis in de gaten. (https://github.com/metbril/home-assistant-config)"
              ],
              "host": [
                "De laatste #backup van Home Assistant is {{ relative(as_datetime(state_attr('sensor.backup_state','last_backup'))) }} oud.",
                "Op {{ as_timestamp(state_attr('sensor.backup_state','last_backup')) | timestamp_custom('%d-%m-%Y %H:%M', true) }} is voor het laatst een #backup gemaakt van Home Assistant."
              ],
              "door": [
                "Het aantal keren dat gisteren op de bel werd gedrukt is {{ states('sensor.doorbell_presses') }}",
                "{{ states('sensor.doorbell_presses') }} mensen kwamen aan de deur vandaag en drukten op de bel.",
                "{{ states('sensor.doorbell_presses') }} deurbelgebruik kwamen voor in de afgelopen 24 uur."
              ],
              # "weather": [
              #   "Wie zijn best doet, kan door het raam ongeveer {{ states('sensor.dark_sky_visibility') | float(0) | round(0) }} km wegkijken.",
              #   "Het is buiten {{ states('sensor.dark_sky_temperature') }} °C, maar het voelt aan als {{ states('sensor.dark_sky_apparent_temperature') }} °C. #DarkSky #weer",
              #   "{{ states('sensor.dark_sky_hourly_summary') }} #DarkSky #weer",
              #   "{{ states('sensor.dark_sky_daily_summary') }} #DarkSky #weer",
              #   "{{ states('sensor.knmi_home_korte_dagverwachting') }} #WeerLive #weer",
              #   "{{ states('sensor.knmi_home_omschrijving') }} #WeerLive #weer",
              #   "De actuele UV-index is {{ states('sensor.dark_sky_uv_index') }}. #weer"
              # ],
              "speedtest": [
                "De pingtijd naar het Internet is {{ states('sensor.wan_ping') }} ms. #speedtest",
                "Gemiddelde Internet-snelheden: download {{ states('sensor.speedtest_download') | float(0) | round(0) }} Mbit/s, upload {{ states('sensor.speedtest_upload') | float(0) | round(0) }} Mbit/s. #speedtest",
                "Mijn downloadsnelheid bij @ZiggoWebcare is ongeveer {{ states('sensor.speedtest_download') | float(0) | round(0) }} Mbit/s. #speedtest"
              ],
              "internet": [
                "Tot nu toe heb ik voorkomen dat {{ states('sensor.adguard_dns_queries_blocked') }} advertenties en trackers het thuisnetwerk konden bereiken door gebruik van AdGuard Home! #Tracking #Privacy (https://adguard.com/nl/adguard-home/overview.html)",
                "Met behulp van {{ states('sensor.adguard_rules_count') }} regels heeft AdGuard Home {{ states('sensor.adguard_dns_queries_blocked_ratio') }}% van de DNS-verzoeken gefilterd op advertenties. #AdBlocker (https://adguard.com/nl/adguard-home/overview.html)",
                "AdGuard Home heeft vandaag {{ states('sensor.adguard_dns_queries') }} DNS-verzoeken afgehandeld! (https://adguard.com/nl/adguard-home/overview.html)"
              ]
            }[pick] | random }}
      - service: script.tweet_engine
        data:
          message: "{{ message }}"

  ##############################################################################
  - alias: Home Assistant Stop Tweet
    id: f1a564aa-c8da-4f88-bf61-b938627374b2

    trigger:
      - platform: homeassistant
        event: shutdown

    action:
      - service: notify.twitter
        data:
          message: >-
            {% set phrases = [
              "💤 Ik ga even een dutje doen.",
              "🚶 Ik moet even weg, maar ik ben zo weer terug.",
              "🙈 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, wie niet weg is, is gezien!",
              "⛔ Home Assistant wordt gestopt."
            ] %}
            {% set hashtags = [
              "#HomeAutomation",
              "#SmartHome",
              "#Domotica",
              "#IoT"
            ] %}
            {{ phrases|random ~ " " ~ hashtags|random ~ " #HomeAssistant" ~
            " https://metbril.github.io/home-assistant-config"}}
          data:
            media: >-
              {% set pictures = [
                "/config/www/img/tweets/uptime/shutdown_laptop.jpg",
                "/config/www/img/tweets/uptime/tv_color_bars.png",
                "/config/www/img/tweets/uptime/tv_offline.jpg",
                "/config/www/img/tweets/uptime/tv_noise.jpg"
              ] %}
              {{ pictures|random }}
